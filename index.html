
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Astroshrae</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Open Graph Meta Tags for Social Sharing - These are for the *main site* -->
    <!-- IMPORTANT NOTE ON SOCIAL SHARING WITH HASH-BASED URLs: -->
    <!-- Social media crawlers (like WhatsApp, Facebook, Twitter) typically DO NOT execute client-side JavaScript. -->
    <!-- This means they will only see the default Open Graph (og:) meta tags defined here in the <head> of your index.html. -->
    <!-- To achieve dynamic product previews (like Amazon), you need Server-Side Rendering (SSR). With this client-side app, -->
    <!-- the best approach is to generate a rich text message for users to share, which includes the product details and a direct link.-->
    <meta property="og:title" content="Astroshrae - Numerology & Spiritual Guidance">
    <meta property="og:description" content="Unlock cosmic truths with personalized numerology services including Name Correction, Marriage Compatibility, and more.">
    <meta property="og:image" content="https://iili.io/K5eHgUb.png"> <!-- Main site image -->
    <meta property="og:url" content="https://astroshrae.rf.gd/home">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Astroshrae">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Astroshrae - Numerology & Spiritual Guidance">
    <meta name="twitter:description" content="Unlock cosmic truths with personalized numerology services.">
    <meta name="twitter:image" content="https://iili.io/K5eHgUb.png">
    
    <!-- Google Fonts – Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Razorpay Checkout -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    
    <style>
        :root {
            --primary: #7266ba;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --text: #212529;
            --bg: #ffffff;
            --radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,.1);
            --font: 'Poppins', sans-serif;
            --gradient: linear-gradient(135deg, #7266ba, #5a4e9b);
        }

        /* Global reset & typography */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font); }
        body { background: var(--light); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        a { color: inherit; text-decoration: none; }
        img { max-width: 100%; height: auto; display: block; border-radius: var(--radius); }
        main { flex-grow: 1; } /* Ensures main content takes available space, pushing footer down */

        /* Header – gradient */
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--gradient);
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            color: #fff;
        }
        .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: #fff;
        }
        .logo img {
            height: 40px;
            margin-right: .5rem;
        }
        .header-icons i {
            font-size: 1.3rem;
            color: #fff;
            margin-left: .8rem;
            cursor: pointer;
        }
        #login-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            display: none;
            margin-right: .5rem;
        }

        /* Bottom navigation – gradient */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--gradient);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            color: #fff;
        }
        .bottom-nav a {
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .bottom-nav a.active {
            color: var(--light);
        }
        .bottom-nav .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background: var(--danger);
            color: #fff;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: .7rem;
        }
        .bottom-nav .badge.hidden {
            display: none;
        }

        /* Pages */
        .page {
            display: none;
            padding: 80px 1rem 80px;
            min-height: calc(100vh - 120px);
        }
        .page.active {
            display: block;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Slider */
        .slider {
            position: relative;
            overflow: hidden;
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }
        .slider img {
            width: 100%;
            height: auto;
            display: block;
        }
        .slider .nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,.4);
            color: #fff;
            padding: .5rem .8rem;
            cursor: pointer;
            border: none;
            border-radius: 50%;
        }
        .slider .prev {
            left: 10px;
        }
        .slider .next {
            right: 10px;
        }

        /* Slider skeleton */
        .slider-image-wrapper {
            width: 100%;
            height: 180px; /* Or a suitable fixed height for the slider area */
            background-color: #f0f0f0; /* Lighter background for skeleton */
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slider-image-wrapper.skeleton {
            background-color: #e0e0e0;
        }

        .slider-image-wrapper.skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            height: 100%;
            width: 150%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 1.5s infinite;
        }

        /* Hide actual image until loaded to show skeleton */
        .slider-image-wrapper img {
            opacity: 0;
            transition: opacity 0.3s ease-in;
            width: 100%; /* Ensure image fills its container */
            height: 100%; /* Ensure image fills its container */
            object-fit: cover; /* or contain, depending on desired behavior */
        }

        /* Show image when it's loaded */
        .slider-image-wrapper img.loaded {
            opacity: 1;
        }

        /* Category bubbles */
        .categories {
            display: flex;
            overflow-x: auto;
            padding: .5rem 0;
            margin-bottom: 1rem;
        }
        .category {
            flex: none;
            background: var(--secondary);
            color: #fff;
            padding: .4rem .8rem;
            border-radius: 20px;
            margin-right: .5rem;
            cursor: pointer;
            font-size: .9rem;
            white-space: nowrap;
        }
        .category.active {
            background: var(--primary);
        }

        /* Product grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        .product-card {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: .8rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .product-card .product-image-container {
            position: relative;
        }
        .product-card img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }
        .product-card h4 {
            font-size: 1rem;
            margin: .5rem 0;
        }
        .product-card .price {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: .5rem;
        }
        .product-card .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem; /* Added margin for separation */
        }
        .product-card button {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: .4rem .6rem;
            border-radius: var(--radius);
            font-size: .8rem;
            cursor: pointer;
        }
        .wishlist {
            font-size: 1.5rem;
            cursor: pointer;
            user-select: none;
        }

        /* Share icon on product image */
        .share-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 5;
        }
        .share-icon i {
            color: var(--primary);
            font-size: 14px;
        }

        /* Quantity buttons – bigger & easy to click */
        .quantity-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: .4rem .8rem;
            border-radius: var(--radius);
            font-size: 1.2rem;
            cursor: pointer;
            margin: 0 .2rem;
        }

        /* Wishlist action buttons */
        .wishlist-action button {
            background: var(--secondary);
            color: #fff;
            border: none;
            padding: .4rem .8rem;
            border-radius: var(--radius);
            font-size: .9rem;
            cursor: pointer;
            margin-right: .4rem;
        }
        .wishlist-action button.move-to-cart {
            background: var(--primary);
        }
        .wishlist-action button.remove-wishlist {
            background: var(--danger);
        }

        /* Status badge (circular ends) - UPDATED COLORS */
        .status-badge {
            display: inline-block;
            padding: .2rem .8rem;
            border-radius: 9999px;
            font-size: .85rem;
            font-weight: 600;
            color: #fff;
            white-space: nowrap; /* Ensure status text doesn't wrap */
            margin: 0 0.25rem; /* Add space/gap as requested */
        }
        /* Specific color classes for statuses */
        .status-red { background: #e53935; } /* Red */
        .status-yellow { background: #ffc107; } /* Yellow */
        .status-light-green { background: #8bc34a; } /* Light Green */
        .status-deep-green { background: #388e3c; } /* Deep Green */
        .status-grey { background: #6c757d; } /* Grey for N/A */
        .status-blue { background: #17a2b8; } /* Info/Blue */


        /* Order Box Styling - NEW */
        .order-box {
            background: #fff;
            border: 2px solid var(--primary); /* Green or matching app template */
            border-radius: var(--radius); /* Square shaped circular ends */
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); /* Soft shadow */
        }

        /* Order buttons – colourful and beautiful */
        .order-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            margin: 0.4rem 0.3rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .order-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        .btn-details {
            background: linear-gradient(135deg, #17a2b8, #0d8cb5);
            color: white;
            border: 2px solid #138ca6;
        }
        .btn-edit {
            background: linear-gradient(135deg, #ffc107, #e6ac00);
            color: #333;
            border: 2px solid #d49d00;
        }
        .btn-edit:disabled {
            background: #cccccc;
            cursor: not-allowed;
            border: 2px solid #b3b3b3;
        }
        .btn-pay-now {
            background: linear-gradient(135deg, var(--primary), #5a4e9b);
            color: white;
            border: 2px solid var(--primary);
        }


        /* Menu buttons - bigger and box type */
        #menu-list {
            list-style: none;
            padding: 0;
            text-align: center;
        }
        #menu-list li {
            margin: 1rem 0;
        }
        #menu-list a {
            display: block;
            padding: 1rem;
            background: var(--gradient);
            color: white;
            border-radius: var(--radius);
            font-weight: 600;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        #menu-list a:hover {
            transform: scale(1.05);
        }

        /* Share modal styling */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .share-modal.active {
            display: flex;
        }
        .share-modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .share-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .share-modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        .share-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .share-options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.8rem;
            border-radius: var(--radius);
            background: var(--light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .share-option:hover {
            background: var(--primary);
            color: white;
        }
        .share-option i {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        .share-option span {
            font-size: 0.8rem;
        }

        /* Modals – blurred backdrop */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,.4);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal.active {
            display: flex;
        }
        .modal .content {
            background: #fff;
            padding: 1.5rem;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal .close {
            position: absolute;
            top: .5rem;
            right: .5rem;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .modal h3 {
            margin-bottom: .8rem;
        }
        .modal input, .modal textarea {
            width: 100%;
            padding: .5rem;
            margin-bottom: .8rem;
            border: 1px solid #ccc;
            border-radius: var(--radius);
        }
        .modal button {
            width: 100%;
            padding: .6rem;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            cursor: pointer;
        }

        /* Contact-Us form – colourful & soft-sided */
        .contact-input {
            width: 100%;
            padding: .8rem;
            margin-bottom: .8rem;
            border: none;
            border-radius: var(--radius);
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            font-size: 1rem;
            box-shadow: var(--shadow);
        }
        .contact-input::placeholder {
            color: #555;
        }
        #contact-form button {
            background: var(--gradient);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            padding: .8rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            transition: transform .2s;
        }
        #contact-form button:hover {
            transform: scale(1.05);
        }

        /* Toast – slide-in */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: #fff;
            padding: .8rem 1.2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: none;
            z-index: 2500;
            animation: slideIn .4s forwards;
            align-items: center;
            text-align: center;
            min-width: 250px;
        }
        .toast.bg-success { background: var(--success); }
        .toast.bg-danger { background: var(--danger); }
        .toast.bg-info { background: var(--info); }
        .toast button {
            background: none;
            color: #fff;
            margin-left: .5rem;
            border: none;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
        }
        .toast button:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px) translateX(-50%); }
            to { opacity: 1; transform: translateY(0) translateX(-50%); }
        }

        .msg-box {
            background: #fff;
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            max-width: 400px;
            margin: auto;
        }
        .msg-box h2 {
            margin-bottom: .5rem;
        }
        .msg-box p {
            margin-bottom: 1rem;
        }
        .msg-box button {
            margin: .3rem 0;
            width: 100%;
            background: var(--primary);
            color: #fff;
            border: none;
            padding: .6rem;
            border-radius: var(--radius);
            cursor: pointer;
        }
        .msg-box button.secondary {
            background: var(--secondary);
        }
        .msg-box button.danger {
            background: var(--danger);
        }

        /* Loading overlay – spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        .loading-overlay.active {
            display: flex;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success page styles */
        .success-icon {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 1rem;
        }
        .order-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .order-detail-item strong {
            font-weight: 600;
        }
        /* Custom button for success page */
        #success-view-order-btn {
            background: linear-gradient(135deg, #7266ba, #5a4e9b);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 30px; /* Circular ends */
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        #success-view-order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* About page styles - ENHANCED */
        .about-section {
            margin-bottom: 2rem;
        }
        .about-content .about-section h3 {
            font-size: 1.4rem;
            color: var(--primary); /* Use primary color for headings */
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            padding-bottom: 0.3rem;
            border-bottom: 2px solid var(--primary); /* A subtle underline */
            display: inline-block; /* Make border-bottom only as wide as text */
            font-weight: 600;
        }
        .about-content p {
            line-height: 1.7; /* Increased line-height for readability */
            margin-bottom: 1rem;
            color: var(--text);
            text-align: justify; /* Justify text for a cleaner look */
        }
        .about-content ul {
            padding-left: 1.8rem;
            margin-bottom: 1rem;
            list-style-type: disc;
        }
        .about-content li {
            margin-bottom: 0.6rem;
            line-height: 1.5;
            color: #444;
        }
        .about-content p strong,
        .about-content li strong {
            color: var(--primary); /* Make strong text in about section colorful */
        }


        /* Product Preview Page Styles - ENHANCED */
        .product-preview-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }
        .product-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .product-preview-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            margin-bottom: 1.5rem;
            border-radius: var(--radius);
        }
        .product-preview-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .product-preview-price {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        .product-preview-description {
            line-height: 1.6;
            margin-bottom: 1.5rem;
            /* Added styling for description itself */
            background: #fdfdfd;
            padding: 1.2rem;
            border-radius: var(--radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: justify;
        }
        /* Specific styling for product preview description headings */
        #product-preview .product-preview-description h2,
        #product-preview .product-preview-description h3 {
            font-size: 1.3rem; /* Slightly smaller for sub-subheadings */
            color: var(--primary);
            background: linear-gradient(90deg, #e0e7ff, #ffffff00); /* Soft gradient background */
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            border-left: 5px solid var(--primary); /* A stronger left border */
            margin-left: -0.8rem; /* Pull it slightly to the left to align with padding */
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            display: block; /* Make it block to span full width of content box */
            font-weight: 600;
        }
        #product-preview .product-preview-description p strong,
        #product-preview .product-preview-description li strong {
            color: var(--primary); /* Make strong text in product description colorful */
        }

        .product-preview-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .product-preview-actions button {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-add-cart {
            background: var(--primary);
            color: white;
        }
        .btn-wishlist {
            background: var(--light);
            color: var(--text);
            border: 1px solid #ddd !important;
        }
        .btn-back {
            background: var(--secondary);
            color: white;
            margin-top: 1rem;
            width: 100%;
            padding: 0.8rem;
            border-radius: var(--radius);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* View Details button */
        .view-details-btn {
            background: var(--info);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: var(--radius);
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 0.5rem; /* Separated from Add to Cart */
            width: 100%; /* Takes full width */
            display: block; /* Ensures it's on its own line */
        }

        /* Coupon section styles - RENAMED AND ADJUSTED FOR MOBILE */
        .coupon-section {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: var(--radius);
            margin: 1rem 0;
        }
        .coupon-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center; /* Vertically align items */
        }
        .coupon-input {
            flex-grow: 1; /* Allow input to take available space */
            width: calc(100% - 70px); /* Make it small, but responsive */
            padding: 0.6rem; /* Slightly larger padding for tap target */
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem; /* Readable font size */
            height: 44px; /* Fixed height for consistency */
        }
        .coupon-btn {
            width: 60px; /* Small fixed width for apply button */
            height: 44px; /* Match input height */
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 0.5rem; /* Adjust padding for small width */
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem; /* Smaller font for "Apply" */
            flex-shrink: 0; /* Prevent shrinking */
        }
        .coupon-message {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            padding: 0.5rem;
            border-radius: var(--radius);
            text-align: center;
        }
        .coupon-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .coupon-error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        /* FAQs Page Styling */
        .faq-item {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 0.8rem;
            overflow: hidden; /* For smooth toggle */
        }
        .faq-question {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--light);
            font-weight: 600;
            cursor: pointer;
            color: var(--primary);
        }
        .faq-question i {
            transition: transform 0.3s ease;
        }
        .faq-answer {
            padding: 0 1rem;
            max-height: 0; /* Hidden by default */
            overflow: hidden;
            transition: max-height 0.3s ease-out; /* Smooth transition */
            background: #fdfdfd;
            border-top: 1px solid #eee;
        }
        .faq-answer p {
            padding: 1rem 0; /* Inner padding for content */
            margin: 0;
            line-height: 1.6;
            color: #444;
        }
        .faq-item.active .faq-question {
            background: var(--primary);
            color: white;
        }
        .faq-item.active .faq-question i {
            transform: rotate(180deg); /* Rotate for ^ icon */
        }
        .faq-item.active .faq-answer {
            max-height: 500px; /* Sufficiently large to show content, adjust if answers are extremely long */
            /* Using height: auto after transition completion is more robust for dynamic content */
        }

        /* Help Pop-up Styling */
        .help-popup {
            position: fixed;
            bottom: 60px; /* Above bottom-nav */
            left: 0;
            right: 0;
            background: #fff; /* White background */
            box-shadow: 0 -2px 10px rgba(0,0,0,.1);
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999; /* Below modals, above bottom-nav */
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            transform: translateY(100%); /* Start hidden below screen */
            transition: transform 0.3s ease-out;
        }
        .help-popup.active {
            transform: translateY(0); /* Slide up when active */
        }
        .help-popup p {
            margin: 0;
            font-weight: 600;
            color: var(--text);
            font-size: 1.1rem;
        }
        .help-popup-buttons {
            display: flex;
            gap: 0.8rem;
        }
        .help-chat-btn, .help-call-btn {
            padding: 0.6rem 1rem;
            border-radius: 30px; /* Circular ends */
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            min-width: 100px;
            box-sizing: border-box; /* Include padding in width calculation */
        }
        .help-chat-btn {
            background: linear-gradient(135deg, #25D366, #128C7E); /* WhatsApp green colors */
            color: white;
            box-shadow: 0 2px 5px rgba(0, 140, 126, 0.3);
        }
        .help-call-btn {
            background: white;
            color: var(--primary); /* Text color from primary for contrast */
            border: 2px solid var(--primary); /* Border matching primary */
            box-shadow: 0 2px 5px rgba(114, 102, 186, 0.2);
        }
        .help-chat-btn:hover, .help-call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Feedback Form Styling */
        .feedback-form-group {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #fdfdfd;
            border-radius: var(--radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .feedback-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.8rem;
            color: var(--primary);
            font-size: 1.1rem;
        }
        .feedback-form-group input[type="text"],
        .feedback-form-group input[type="email"],
        .feedback-form-group input[type="password"], /* Added for new auth form */
        .feedback-form-group input[type="date"], /* Added for new auth form */
        .feedback-form-group input[type="tel"], /* Added for new auth form */
        .feedback-form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
            margin-top: 0.5rem;
            background: #fff;
        }
        .feedback-form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .feedback-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        .feedback-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.6rem 1rem;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: #fff;
            transition: all 0.2s ease;
            user-select: none;
        }
        .feedback-option input[type="text"] {
            margin-left: 0.5rem;
            width: auto; /* Allow specific other input to be smaller */
            min-width: 80px;
            flex-grow: 1; /* Allow it to grow in flex container */
            padding: 0.3rem 0.6rem;
        }
        .feedback-option input[type="checkbox"],
        .feedback-option input[type="radio"] {
            margin-right: 0.6rem;
            accent-color: var(--primary); /* Style checkbox/radio */
            width: 18px;
            height: 18px;
        }
        .feedback-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .feedback-option.selected input[type="checkbox"],
        .feedback-option.selected input[type="radio"] {
            filter: invert(1) hue-rotate(180deg); /* Make checkbox/radio visible on dark background */
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 0.2rem;
            margin-top: 0.5rem;
        }
        .star-rating i {
            font-size: 1.5rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating i.active {
            color: #ffc107; /* Gold color for active stars */
        }

        /* Button for main feedback submit */
        #feedback-submit-btn {
            background: var(--gradient);
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        #feedback-submit-btn:hover {
            transform: translateY(-2px);
        }

        /* NEW button for feedback auth/verify */
        #feedback-verify-btn {
            background: var(--primary); /* Purple */
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }
        #feedback-verify-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        #feedback-verify-btn:disabled {
            background: #ccc; /* Grey/White */
            color: #666;
            cursor: not-allowed;
            transform: none;
        }


        /* Reviews Page Styling */
        .review-box {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-left: 5px solid var(--primary);
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Stack contents vertically */
            align-items: flex-start; /* Align text to start */
        }
        .review-box .reviewer-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            width: 100%; /* Take full width */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .review-box .review-text {
            line-height: 1.6;
            color: #444;
            margin-bottom: 0.8rem;
            text-align: justify;
        }
        .review-box .review-stars {
            margin-bottom: 0.8rem;
        }
        .review-box .review-stars i {
            color: #ffc107;
            font-size: 1.2rem;
        }
        .review-box .review-actions { /* New div to contain helpful buttons and delete/edit */
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.8rem;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }
        .review-box .helpful-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap; /* Allow buttons to wrap */
        }
        .review-box .helpful-buttons button {
            background: var(--light);
            color: var(--text);
            border: 1px solid #ddd;
            padding: 0.4rem 0.8rem;
            border-radius: var(--radius);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .review-box .helpful-buttons button:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .review-box .helpful-buttons button:disabled {
            background: #eee;
            color: #aaa;
            cursor: not-allowed;
        }

        .review-box .user-review-actions { /* Container for edit/delete buttons */
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-left: auto; /* Push to the right */
        }
        .review-box .edit-review-btn, .review-box .delete-review-btn {
            background: var(--info);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: var(--radius);
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .review-box .edit-review-btn:hover {
            background: #0d8cb5;
        }
        .review-box .delete-review-btn {
            background: var(--danger);
        }
        .review-box .delete-review-btn:hover {
            background: #c82333;
        }

        /* NEW: Admin Reply Styling */
        .admin-reply {
            width: 100%;
            margin-top: 1rem;
            padding: 1rem;
            background: #f1f3ff; /* Light purple/blue background */
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }
        .admin-reply-header {
            display: flex; /* Use flex to align icon and text */
            align-items: center;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .admin-reply-header i {
            margin-right: 0.5rem;
            font-size: 1.1rem; /* Slightly larger icon */
            color: var(--warning); /* Star color for admin icon */
        }
        .admin-reply-date {
            font-size: 0.8rem;
            color: #666;
            margin-left: auto; /* Push date to the right */
        }
        .admin-reply-text {
            line-height: 1.6;
            color: #333;
            margin: 0;
            text-align: justify;
        }
        
        /* NEW: Skeleton Loader Styles */
        .skeleton {
            background-color: #e0e0e0;
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
        }
        .skeleton-image { height: 120px; }
        .skeleton-title { height: 20px; width: 80%; margin: 10px auto; }
        .skeleton-price { height: 16px; width: 40%; margin: 10px auto; }
        .skeleton-button { height: 30px; width: 90%; margin: 10px auto; }

        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            height: 100%;
            width: 150%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { left: -150%; }
            100% { left: 150%; }
        }

        /* Misc helpers */
        .hidden { display: none !important; } /* Use important to override block */
        .center { text-align: center; }
        .mt-1 { margin-top: .5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: .5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mr-1 { margin-right: .5rem; }
        .ml-1 { margin-left: .5rem; }
        .flex { display: flex; align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .bg-success { background: var(--success); }
        .bg-danger { background: var(--danger); }
        .bg-primary { background: var(--primary); }
        .rounded { border-radius: var(--radius); }
        .p-1 { padding: .5rem; }
        .p-2 { padding: 1rem; }
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <a href="/home" class="logo">
            <img src="https://iili.io/K5eHgUb.png" alt="Astroshrae Logo" loading="eager">
            Astroshrae
        </a>
        <div class="header-icons flex">
            <div id="login-status-indicator"></div>
            <i class="fas fa-search" id="search-icon"></i>
            <i class="fas fa-user" id="profile-icon"></i>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content">
        <!-- Home -->
        <section id="home" class="page active">
            <div class="slider" id="slider">
                <!-- Slider image wrapper for skeleton loading -->
                <div class="slider-image-wrapper skeleton" id="slider-image-wrapper">
                    <img src="" alt="Slider Image" id="slider-img" loading="eager">
                </div>
                <button class="nav prev" id="slider-prev"><i class="fas fa-chevron-left"></i></button>
                <button class="nav next" id="slider-next"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="categories" id="category-list"></div>
            <div class="product-grid" id="product-grid"></div>
        </section>

        <!-- Search -->
        <section id="search" class="page">
            <h2 class="section-title">Search Services</h2>
            <input type="text" id="search-input" placeholder="Search by name..." class="p-1 rounded mb-2" style="width:100%;">
            <div class="product-grid" id="search-results"></div>
        </section>

        <!-- Cart -->
        <section id="cart" class="page">
            <h2 class="section-title">Your Cart</h2>
            <div id="cart-list"></div>
            <div class="coupon-section">
                <h3>Apply Coupon</h3>
                <div class="coupon-input-group">
                <input type="text" id="coupon-code" class="coupon-input" placeholder="Enter coupon code">
                <button id="apply-coupon" class="coupon-btn">Apply</button>
                </div>
                <div id="coupon-message" class="coupon-message"></div>
            </div>
            <div class="mt-2 flex justify-between">
                <strong>Subtotal:</strong>
                <strong id="cart-subtotal">₹0</strong>
            </div>
            <div class="mt-1 flex justify-between">
                <strong>Discount:</strong>
                <strong id="cart-discount">-₹0</strong>
            </div>
            <!-- TRANSACTION FEES ARE NOT SHOWN HERE IN CART TOTAL AS PER REQUIREMENT -->
            <div class="mt-1 flex justify-between">
                <strong>Total:</strong>
                <strong id="cart-total">₹0</strong>
            </div>
            <button id="checkout-btn" class="mt-2 bg-primary text-white rounded p-1 cursor-pointer" style="width:100%; padding: 0.8rem; font-size: 1rem;">Proceed to Checkout</button>
        </section>

        <!-- Wishlist -->
        <section id="wishlist" class="page">
            <h2 class="section-title">Your Wishlist</h2>
            <div id="wishlist-list"></div>
        </section>

        <!-- Orders -->
        <section id="order" class="page">
            <h2 class="section-title">My Orders</h2>
            <div id="orders-list"></div>
        </section>

        <!-- Profile -->
        <section id="profile" class="page">
            <h2 class="section-title">My Profile</h2>
            <div id="profile-info" class="p-2 rounded bg-light mb-2"></div>
            <button id="edit-profile-btn" class="bg-primary text-white rounded p-1 mb-2 cursor-pointer" style="width:100%;">Edit Profile</button>
            <button id="logout-btn" class="bg-danger text-white rounded p-1 cursor-pointer" style="width:100%;">Logout</button>
        </section>

        <!-- About -->
        <section id="about" class="page">
            <h2 class="section-title">About Astroshrae</h2>
            <div class="p-2 about-content">
                <div class="about-section">
                    <h3>The Soul of Astroshrae</h3>
                    <p>Astroshrae is more than a brand. It is a guiding light, a sacred space, and a journey into the mystical yet scientific world of numerology, vastu, and spiritual harmony. The name itself is born from a vision of bringing light, balance, and wisdom to seekers across the world.</p>
                    <p>At Astroshrae, we believe that numbers hold magic. They are not random figures but carriers of vibrations, cosmic patterns, and universal truths. Every number resonates with an energy that influences our lives—shaping our personalities, relationships, careers, health, and destiny. By decoding these vibrations, Astroshrae offers clarity, empowerment, and transformation.</p>
                    <p>We are not fortune-tellers; we are interpreters of universal wisdom. Through our guidance, you learn not only what life holds for you, but also how to align with your destiny, make wise choices, and unlock hidden potential.</p>
                </div>
                <div class="about-section">
                    <h3>Our Journey and Inspiration</h3>
                    <p>Astroshrae was founded on a deep realization: that people are constantly searching for clarity and meaning in a fast-changing world. While technology advances and lifestyles evolve, human questions remain timeless—Who am I? Why do I face repeated struggles? How can I achieve balance and peace?</p>
                    <p>The founder of Astroshrae, moved by both personal experiences and years of study, discovered how numbers serve as silent yet powerful answers to these eternal questions. By practicing numerology, they began offering guidance to friends, family, and the community. The results were undeniable—students found focus, businesses flourished, marriages improved, and individuals felt lighter, calmer, and more confident.</p>
                    <p>What began as a personal calling soon blossomed into a mission. Astroshrae emerged as a platform to share this gift with the world—combining ancient wisdom with modern insight. Today, Astroshrae is a trusted name for those who seek not just answers, but transformation.</p>
                </div>
                <div class="about-section">
                    <h3>Our Mission and Philosophy</h3>
                    <p>Astroshrae exists with a clear mission:</p>
                    <ul>
                        <li>To help individuals decode their life path using numerology.</li>
                        <li>To provide clarity and guidance in personal, professional, and spiritual matters.</li>
                        <li>To empower seekers with practical remedies rooted in Vedic, Feng Shui, and Numerological systems.</li>
                        <li>To bring harmony to homes, businesses, relationships, and individual lives.</li>
                    </ul>
                    <p>Our philosophy rests on three pillars:</p>
                    <ul>
                        <li><strong>Authenticity</strong> – Every analysis and remedy is genuine, rooted in numerological and spiritual knowledge.</li>
                        <li><strong>Compassion</strong> – We serve not to instill fear, but to uplift with hope, guidance, and positivity.</li>
                        <li><strong>Transformation</strong> – We believe in real, lasting change through alignment of energy, not empty promises.</li>
                    </ul>
                    <p>At Astroshrae, every consultation is handled with care, confidentiality, and respect. We are not here to control lives but to guide individuals toward their best possible selves.</p>
                </div>
                <div class="about-section">
                    <h3>Our Services</h3>
                    <p>Astroshrae provides a wide range of services that address every dimension of life—personal, professional, and spiritual. Each service is designed to bring harmony, clarity, and progress.</p>
                </div>
                <div class="about-section">
                    <h3>Why Choose Astroshrae</h3>
                    <p>Astroshrae is trusted because we offer more than predictions—we offer transformation.</p>
                    <ul>
                        <li>Our guidance is ethical, compassionate, and empowering.</li>
                        <li>We blend traditional wisdom with modern presentation.</li>
                        <li>Our services are affordable and accessible, designed for everyone.</li>
                        <li>We have touched lives by helping students, families, couples, entrepreneurs, and spiritual seekers.</li>
                        <li>Every remedy is practical, simple, and effective.</li>
                    </ul>
                    <p>We believe that everyone deserves to live a harmonious and prosperous life. Astroshrae is committed to making this possible.</p>
                </div>
                <div class="about-section">
                    <h3>The Power of Numbers</h3>
                    <p>Numbers are not random—they are the building blocks of the universe. From the planets' cycles to the rhythm of music, everything is mathematical. Your personal numbers—birth date, name, and daily vibrations—carry hidden codes of your life.</p>
                    <p>By understanding them, you can:</p>
                    <ul>
                        <li>Make wiser decisions.</li>
                        <li>Improve relationships.</li>
                        <li>Align your career with your destiny.</li>
                        <li>Overcome struggles and challenges.</li>
                        <li>Unlock inner peace and confidence.</li>
                    </ul>
                    <p>At Astroshrae, we show you how to work with these energies to create the life you deserve.</p>
                </div>
                <div class="about-section">
                    <h3>Our Social Impact</h3>
                    <p>Astroshrae is not just about individuals—it is about uplifting society. By guiding one person, we uplift a family; by guiding families, we uplift communities. Students gain confidence, businesses create opportunities, couples create harmony, and communities spread positivity.</p>
                    <p>We see our work as a social service through spiritual science.</p>
                </div>
                <div class="about-section">
                    <h3>Future Vision of Astroshrae</h3>
                    <p>Astroshrae is continuously growing, with dreams to expand globally. Our future vision includes:</p>
                    <ul>
                        <li>Creating digital platforms and apps for easy access to numerology.</li>
                        <li>Offering courses and workshops to spread awareness.</li>
                        <li>Partnering with schools, organizations, and businesses for mass guidance.</li>
                        <li>Building a global community of numerology learners and seekers.</li>
                    </ul>
                    <p>We dream of a world where numerology is respected as a guiding science that helps millions live more meaningful lives.</p>
                </div>
                <div class="about-section">
                    <h3>Closing Message</h3>
                    <p>Life is a beautiful journey, but it becomes clearer when you know the map. Numbers are that map, and Astroshrae is here to help you read it.</p>
                    <p>Whether you seek peace, prosperity, love, or clarity, Astroshrae is your companion on this path. We invite you to discover the magic of numbers and experience how alignment with universal vibrations can transform your life.</p>
                    <p>At Astroshrae, we believe deeply that:</p>
                    <p><strong>Numbers Hold Magic. And with Astroshrae, you can unlock that magic to live your best life.</strong></p>
                </div>
            </div>
        </section>

        <!-- Terms -->
        <section id="terms" class="page">
            <h2 class="section-title">Terms & Conditions</h2>
            <div class="p-2">
                <h3>🌌 Astroshrae Terms and Conditions</h3>
                <p><strong>Official Website:</strong> https://astroshrae.rf.gd/home</p>
                <p><strong>Contact Email:</strong> astroshrae1@gmail.com</p>
                <p><strong>Support Phone:</strong> +91 9436906667</p>
                <p><strong>Service Owner:</strong> Pushapa Rainii Das</p>
                <div class="about-section">
                    <h3>🌠 Introduction</h3>
                    <p>Welcome to Astroshrae — your trusted portal for unlocking cosmic truths, numerological knowledge, and personalized life path insights. These Terms and Conditions ("Terms") serve as the foundational agreement between you (the user) and Astroshrae regarding the access and use of our website, services, applications, tools, and digital products.</p>
                    <p>By accessing or using Astroshrae, you agree to be legally bound by these Terms, which outline your rights, responsibilities, and limitations as a user of our platform. If you do not agree with these Terms, in full or in part, you are advised to discontinue use of our services.</p>
                    <p>Astroshrae provides users with access to spiritual insights and personalized experiences through numerology. Our platform supports both casual interest and deep-diving seekers by offering life path readings, karmic interpretations, personal guidance reports, compatibility analysis, numerological education, and booking consultations.</p>
                    <p>We hold your spiritual journey sacred, and our commitment to ethical conduct, integrity, and transparency is reflected throughout this document.</p>
                </div>
                <div class="about-section">
                    <h3>🔮 Purpose of Services</h3>
                    <p>Astroshrae's offerings are rooted in numerology and designed for spiritual enrichment and personal exploration. We provide services that aim to:</p>
                    <ul>
                        <li>Deliver clarity and perspective through symbolic number interpretations</li>
                        <li>Help individuals understand cycles, challenges, and spiritual lessons</li>
                        <li>Facilitate personal transformation and self-awareness</li>
                        <li>Encourage conscious decision-making through energy-based insights</li>
                    </ul>
                    <p>Our guidance is intended as supplementary and educational in nature. We do not provide medical diagnoses, legal judgments, or financial guarantees. Always consult appropriate professionals when needed, and use our services to complement your journey, not replace grounded decision-making.</p>
                </div>
                <div class="about-section">
                    <h3>👤 User Eligibility</h3>
                    <p>To use our services, users must:</p>
                    <ul>
                        <li>Be at least 18 years of age, or have verified parental/guardian consent</li>
                        <li>Provide true, current, and complete information during registration</li>
                        <li>Comply with applicable laws, ethical guidelines, and community standards</li>
                        <li>Avoid misrepresentation or impersonation of any person or entity</li>
                    </ul>
                    <p>We reserve the right to deny or terminate access to users found violating these Terms or engaging in suspicious or harmful behavior.</p>
                </div>
                <div class="about-section">
                    <h3>🛡️ Account Registration and Use</h3>
                    <p>Creating an Astroshrae account enables you to access personalized dashboards, receive readings, manage sessions, and track progress. By creating an account, you agree to:</p>
                    <ul>
                        <li>Maintain confidentiality of login credentials</li>
                        <li>Notify us of unauthorized access or suspicious activity</li>
                        <li>Refrain from sharing your account or credentials</li>
                        <li>Accept responsibility for actions taken under your account</li>
                    </ul>
                    <p>Users are not permitted to create multiple accounts for the same individual or use automated means to access the platform.</p>
                </div>
                <div class="about-section">
                    <h3>📅 Personal Data Collection</h3>
                    <p>We collect essential user data to tailor our services to your unique numerological profile. This includes:</p>
                    <ul>
                        <li><strong>Full Name</strong> — Used to compute personality, destiny, and soul urge numbers</li>
                        <li><strong>Date of Birth</strong> — Required for life path calculations and timing cycles</li>
                        <li><strong>Email</strong> — For identity verification, report delivery, session updates</li>
                        <li><strong>Phone Number</strong> — To send reminders, verification codes, and reading links</li>
                        <li><strong>Reading History</strong> — Stored securely to enhance continuity in consultations</li>
                    </ul>
                    <p>For details on how your data is stored and protected, please refer to our Privacy Policy.</p>
                </div>
                <div class="about-section">
                    <h3>📚 Intellectual Property Rights</h3>
                    <p>All content on Astroshrae is the intellectual property of Pushapa Rainii Das and/or its contributors. This includes:</p>
                    <ul>
                        <li>Numerology content, formulas, reports, and learning materials</li>
                        <li>Website design, graphics, icons, and visuals</li>
                        <li>Logos, brand identifiers, and proprietary templates</li>
                    </ul>
                    <p>Users may not reproduce, sell, or distribute our content without prior written permission. Personal use and sharing with attribution is allowed, but commercial redistribution is strictly prohibited.</p>
                </div>
                <div class="about-section">
                    <h3>🌐 Platform Availability</h3>
                    <p>We strive to offer reliable, continuous access to our services. However, platform access may be interrupted due to:</p>
                    <ul>
                        <li>Scheduled updates and maintenance</li>
                        <li>Technical issues or third-party hosting disruptions</li>
                        <li>Emergency circumstances beyond our control</li>
                    </ul>
                    <p>We will make every effort to restore service promptly and inform users of expected downtimes when possible.</p>
                </div>
                <div class="about-section">
                    <h3>💳 Payment Terms</h3>
                    <p>Astroshrae offers both free and premium services. Paid services are clearly priced and outlined prior to purchase. By making a payment, you agree to:</p>
                    <ul>
                        <li>Use authorized and valid payment methods</li>
                        <li>Review service inclusions before completing purchase</li>
                        <li>Understand that personalized readings are non-refundable</li>
                    </ul>
                    <p>Refunds will only be issued in case of technical errors, duplicate payments, or undelivered services.</p>
                </div>
                <div class="about-section">
                    <h3>🔁 Cancellations & Refunds</h3>
                    <p>Due to the customized nature of our services, all sales are final. You may contact us within 7 days of purchase in the following cases:</p>
                    <ul>
                        <li>Technical issues preventing report access</li>
                        <li>Duplicate billing or incorrect charges</li>
                        <li>Session missed by Astroshrae staff</li>
                    </ul>
                    <p>Requests will be evaluated, and if valid, a refund or session credit will be granted.</p>
                </div>
                <div class="about-section">
                    <h3>🚫 Prohibited Conduct</h3>
                    <p>You agree not to:</p>
                    <ul>
                        <li>Misuse or tamper with the platform infrastructure</li>
                        <li>Harass, threaten, or impersonate others</li>
                        <li>Post or transmit malicious code</li>
                        <li>Copy or exploit content for unauthorized gain</li>
                    </ul>
                    <p>Violation of any rule may result in suspension or permanent banning from the platform, and legal action if necessary.</p>
                </div>
                <div class="about-section">
                    <h3>📣 Communication and Notifications</h3>
                    <p>By using Astroshrae, you agree to receive communication related to:</p>
                    <ul>
                        <li>Service updates, booking alerts, and reading links</li>
                        <li>Account changes and password resets</li>
                        <li>Optional newsletters, offers, and announcements</li>
                    </ul>
                    <p>You may opt out of marketing emails at any time, but transactional and essential communications will continue as long as your account is active.</p>
                </div>
                <div class="about-section">
                    <h3>⚠️ Disclaimer and Limitation of Liability</h3>
                    <p>Astroshrae does not guarantee outcomes or absolute interpretations. Our readings are:</p>
                    <ul>
                        <li>Based on traditional numerology systems</li>
                        <li>Subject to interpretation and spiritual discretion</li>
                        <li>Not a substitute for professional advice</li>
                    </ul>
                    <p>We are not responsible for:</p>
                    <ul>
                        <li>Personal or business decisions influenced by our readings</li>
                        <li>Any direct or indirect losses</li>
                        <li>Third-party service failures</li>
                    </ul>
                    <p>Users accept all responsibility for their use of Astroshrae.</p>
                </div>
                <div class="about-section">
                    <h3>🔄 Modifications to Terms</h3>
                    <p>We reserve the right to amend these Terms at any time. Updates may reflect:</p>
                    <ul>
                        <li>New features or services</li>
                        <li>Legal or compliance changes</li>
                        <li>User feedback and usability improvements</li>
                        </ul>
                    <p>Users will be notified via email or dashboard. Continued use of Astroshrae after changes signifies acceptance.</p>
                </div>
                <div class="about-section">
                    <h3>📬 Customer Support</h3>
                    <p>For any inquiries, support requests, or feedback:</p>
                    <p>📧 Email: astroshrae1@gmail.com</p>
                    <p>📞 Phone: +91 9436906667</p>
                    <p>We're honored to guide you through your numerological and spiritual evolution. Your growth, privacy, and satisfaction remain our highest priority.</p>
                </div>
            </div>
        </section>

        <!-- Privacy -->
        <section id="privacy" class="page">
            <h2 class="section-title">Privacy Policy</h2>
            <div class="p-2">
                <h3>🔒 Astroshrae Privacy Policy</h3>
                <p><strong>Website:</strong> https://astroshrae.rf.gd/home</p>
                <p><strong>Email:</strong> astroshrae1@gmail.com</p>
                <p><strong>Phone:</strong> +91 9436906667</p>
                <p><strong>Owner:</strong> Pushapa Rainii Das</p>
                <div class="about-section">
                    <h3>🌟 Introduction</h3>
                    <p>Welcome to Astroshrae, your sacred space for uncovering numerology-based insights, highly personalized life readings, and spiritually guided transformational experiences. At Astroshrae, your privacy and the confidentiality of your spiritual information are not just formalities—they form the core foundation of our ethical and professional values. We treat your data as sacred, and it is handled with deep respect, caution, and absolute care.</p>
                    <p>This Privacy Policy has been meticulously prepared to help you understand, in full transparency, how we collect, use, retain, protect, and honor the personal data you share with us. Whether you are seeking a quick look at your Life Path Number or exploring a multi-layered karmic energy map, you can trust us to guard your information with the highest standards of data security, confidentiality, and spiritual mindfulness.</p>
                    <p>Every name, every number, and every date of birth holds an energetic vibration—a resonance that tells a story of your path, purpose, and life lessons. These personal vibrations form the very essence of our numerological practice. That's why the technology and security systems behind Astroshrae are built not only for accuracy and efficiency, but also for spiritual reverence. We are not simply storing data—we are preserving sacred insight into your soul's journey.</p>
                    <p>Our commitment to privacy is not only rooted in best-in-class cybersecurity practices, but also in a conscious and ethical responsibility. We are committed to building and maintaining your trust, now and always.</p>
                </div>
                <div class="about-section">
                    <h3>📋 What Information We Collect</h3>
                    <p>To personalize our services and deliver the most relevant numerology guidance to you, we collect several types of information through our forms, dashboards, consultations, and interaction points. These include:</p>
                    <ul>
                        <li><strong>Full Name:</strong> We use your name to calculate your Destiny Number, Personality Number, Soul Urge Number, and other important numerology values. Each letter in your name corresponds with a unique vibrational frequency, and understanding this pattern allows us to interpret the blueprint of your inner and outer persona.</li>
                        <li><strong>Date of Birth (DOB):</strong> The backbone of numerology readings, your birth date is essential for determining your Life Path Number, Birth Day Number, Personal Year cycles, Pinnacle Periods, Challenges, and Karmic Debts. It also supports forecasting your spiritual timing and transformational gateways.</li>
                        <li><strong>Email Address:</strong> This is required for communication and account identification. We use your email to send verification links, delivery of personalized numerology reports, updates, confirmations, newsletters, spiritual tips, account-related support, and service feedback forms.</li>
                        <li><strong>Phone Number:</strong> We use this to enhance security through OTPs, confirm bookings or sessions, send alerts and timely numerology updates, and provide reading links through messaging platforms like SMS or WhatsApp. Your phone number is never used for promotional campaigns unless you opt-in.</li>
                        <li><strong>Authentication Credentials:</strong> These include your chosen username, password, and secure session identifiers. All credentials are encrypted to safeguard your login activity and maintain the integrity of your private dashboard.</li>
                        <li><strong>Additional Preferences and Data:</strong> This includes responses to optional quizzes, chosen numerology systems (Pythagorean, Chaldean, Vedic), consultation notes, birth place, language preferences, past reading history, feedback responses, service rating scores, and any questions or goals submitted during form entries.</li>
                    </ul>
                    <p>We do not collect or retain any sensitive payment details. All transactions are conducted securely via third-party gateways that adhere to international financial security protocols suchs as PCI-DSS.</p>
                </div>
                <div class="about-section">
                    <h3>🧭 Why We Collect Your Information</h3>
                    <p>We collect and use your information for purposes that align directly with the functioning of our numerology services. These include:</p>
                    <ul>
                        <li>To generate personalized and detailed numerological readings using your name and birth date.</li>
                        <li>To establish a secure account for you with login access to your personal dashboard, past readings, and future consultations.</li>
                        <li>To send booking confirmations, spiritual reminders, and insightful messages aligned to your numerological timelines.</li>
                        <li>To retain a record of your reading history so we can offer improved accuracy and guidance in repeat consultations.</li>
                        <li>To personalize your experience by considering your interests, preferences, and unique chart configurations.</li>
                        <li>To respond to your queries through support channels quickly and precisely.</li>
                        <li>To comply with legal, regulatory, or safety requirements where necessary.</li>
                    </ul>
                    <p>We use your data exclusively to deliver the services you request and to improve the spiritual depth and technical efficiency of our platform. No data is collected for irrelevant or commercial purposes. We absolutely never sell, trade, or rent your data to third-party marketers.</p>
                </div>
                <div class="about-section">
                    <h3>💡 How We Use Your Information</h3>
                    <p>Your personal information is used in multiple meaningful and relevant ways:</p>
                    <ul>
                        <li>To conduct precise numerology chart analysis using your full name and DOB.</li>
                        <li>To deliver written or visual numerology reports via email, dashboard, or messaging apps.</li>
                        <li>To enable personalized dashboard features, including saved sessions and suggested next steps.</li>
                        <li>To track your progress and energy cycles for accurate follow-ups.</li>
                        <li>To secure your account and manage login sessions and password resets.</li>
                        <li>To send relevant updates about new features, readings, or personalized recommendations.</li>
                        <li>To provide assistance through chat, email, or phone support channels based on your existing service history.</li>
                    </ul>
                    <p>Every use of your information is limited to your interaction with Astroshrae. We do not process or utilize your data for unsolicited messaging or non-numerological purposes.</p>
                </div>
                <div class="about-section">
                    <h3>🛡️ Authentication and Security</h3>
                    <p>We use a layered and evolving system of security tools and practices to keep your data safe:</p>
                    <ul>
                        <li><strong>Encrypted Passwords:</strong> All stored passwords are converted into unreadable hash values that cannot be reversed.</li>
                        <li><strong>Multi-Factor Authentication:</strong> Includes secondary verifications such as OTP via email or SMS.</li>
                        <li><strong>IP and Device Monitoring:</strong> We detect and respond to unknown login attempts.</li>
                        <li><strong>Automatic Logout:</strong> Idle sessions are automatically timed out to prevent misuse.</li>
                        <li><strong>Internal Access Protocols:</strong> Only specific and authorized team members may access sensitive user data when required for support.</li>
                    </ul>
                    <p>We continuously review, upgrade, and monitor our systems for vulnerabilities and emerging threats.</p>
                </div>
                <div class="about-section">
                    <h3>🔐 Data Protection and Security Measures</h3>
                    <p>Your privacy is protected through a system of layered digital safeguards, including:</p>
                    <ul>
                        <li><strong>SSL Encryption:</strong> All information transmitted between your browser and our servers is encrypted to prevent interception.</li>
                        <li><strong>Firewalled and Encrypted Servers:</strong> Our cloud-based storage infrastructure is both firewall-secured and encrypted.</li>
                        <li><strong>Redundant Backups:</strong> All user data is backed up in multiple secure locations daily.</li>
                        <li><strong>AI-Driven Intrusion Detection:</strong> We utilize automated tools to detect and prevent threats.</li>
                        <li><strong>Routine Security Audits:</strong> Scheduled audits and compliance checks keep our system defenses up-to-date.</li>
                    </ul>
                    <p>In the event of a breach, we have a structured emergency protocol, including notifying affected users and conducting independent investigations.</p>
                </div>
                <div class="about-section">
                    <h3>🔄 Data Sharing Policy</h3>
                    <p>We share your data only when absolutely necessary and under secure, clearly defined conditions:</p>
                    <ul>
                        <li>When needed to deliver a service (e.g., sending a report via third-party email platforms).</li>
                        <li>When complying with a valid legal requirement or court order.</li>
                        <li>When you've explicitly requested or consented to a co-reading with a coach or collaborator.</li>
                    </ul>
                    <p>Third-party partners are required to comply with our privacy standards and must enter confidentiality agreements. We never allow your data to be shared for commercial advertising, marketing campaigns, or irrelevant partnerships.</p>
                </div>
                <div class="about-section">
                    <h3>🍪 Cookies and Tracking</h3>
                    <p>We use cookies and tracking tools to:</p>
                    <ul>
                        <li>Improve page loading speed and interactive content.</li>
                        <li>Maintain secure login sessions and preferences.</li>
                        <li>Understand how users interact with different features.</li>
                        <li>Recommend personalized content.</li>
                    </ul>
                    <p>You have full control over cookie permissions in your browser. Disabling cookies may limit access to some features.</p>
                </div>
                <div class="about-section">
                    <h3>🧾 Your Rights Over Your Data</h3>
                    <p>You are empowered with rights concerning your data. These include:</p>
                    <ul>
                        <li><strong>Access:</strong> You may request a full report on all data we store about you.</li>
                        <li><strong>Correction:</strong> You may ask for corrections to inaccurate or outdated information.</li>
                        <li><strong>Deletion:</strong> You may request permanent erasure of your account and all associated records.</li>
                        <li><strong>Consent Withdrawal:</strong> You can revoke previously given permissions.</li>
                        <li><strong>Restriction:</strong> You can ask us to limit how certain data is used.</li>
                    </ul>
                    <p>Requests can be made by emailing astroshrae1@gmail.com. We will respond within 14 working days and follow all applicable laws.</p>
                </div>
                <div class="about-section">
                    <h3>🔄 Policy Changes & Consent</h3>
                    <p>By using Astroshrae, you agree to our privacy terms. If we make significant changes to this policy, we will inform you by email or through an. alert on your dashboard.</p>
                    <p>Continued use of Astroshrae following any updates indicates your acceptance of those changes.</p>
                </div>
                <div class="about-section">
                    <h3>📬 Contact Us</h3>
                    <p>Questions? Concerns? Requests? We are here to help you with clarity, compassion, and care.</p>
                    <p>📧 Email: astroshrae1@gmail.com</p>
                    <p>📞 Phone: +91 9436906667</p>
                    <p>We deeply appreciate the trust you place in Astroshrae. Your path is sacred, and we are honored to support and protect you every step of the way.</p>
                </div>
            </div>
        </section>

        <!-- Contact -->
        <section id="contact" class="page">
            <h2 class="section-title">Contact Us</h2>
            <form id="contact-form">
                <input type="text" id="contact-name" class="contact-input" placeholder="Your Name" required>
                <input type="tel" id="contact-phone" class="contact-input" placeholder="Phone Number" required>
                <input type="email" id="contact-email" class="contact-input" placeholder="Your Email" required>
                <textarea id="contact-message" class="contact-input" rows="4" placeholder="Your Message" required></textarea>
                <button type="submit">Send Message</button>
            </form>
        </section>

        <!-- Success -->
        <section id="success" class="page">
            <div class="msg-box">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>Your Payment Was Successfully Done ✅</h2>
                <p id="success-status">And Your Order's Status Is <strong>Paid</strong></p>
                <div class="order-details mt-2">
                    <div class="order-detail-item">
                        <strong>Name:</strong>
                        <span id="success-name"></span>
                    </div>
                    <div class="order-detail-item">
                        <strong>DOB:</strong>
                        <span id="success-dob"></span>
                    </div>
                    <div class="order-detail-item">
                        <strong>Gmail:</strong>
                        <span id="success-email"></span>
                    </div>
                    <div class="order-detail-item">
                        <strong>Phone Number:</strong>
                        <span id="success-phone"></span>
                    </div>
                </div>
                <button id="success-view-order-btn" class="mt-2">Go To My Orders</button>
            </div>
        </section>

        <!-- Failure -->
        <section id="failure" class="page">
            <div class="msg-box">
                <h2>Payment Failed / Cancelled</h2>
                <p id="failure-msg">Your payment could not be completed. Your order has been placed with status 'Pending'.</p>
                <button id="failure-pay-now-btn" class="bg-primary mb-1">Retry Pay Now</button>
                <button id="failure-pay-later-btn" class="secondary mb-1">Switch to Pay Later</button>
                <button id="failure-cancel-order-btn" class="danger">Cancel Order</button>
            </div>
        </section>

        <!-- Product Preview Page -->
        <section id="product-preview" class="page">
            <div class="product-preview-container">
                <div class="product-preview-header">
                    <h2 class="product-preview-title" id="preview-title"></h2>
                    <span class="product-preview-price" id="preview-price"></span>
                </div>
                <img src="" alt="Product Image" id="preview-image" class="product-preview-image" loading="eager">
                <div class="product-preview-actions">
                    <button class="btn-add-cart" id="preview-add-cart">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                    <button class="btn-wishlist" id="preview-add-wishlist">
                        <i class="fas fa-heart"></i> Add to Wishlist
                    </button>
                </div>
                <div class="product-preview-description" id="preview-description"></div>
                <div class="share-option-container">
                    <h3>Share this service</h3>
                    <div class="share-options-grid">
                        <div class="share-option" data-platform="whatsapp">
                            <i class="fab fa-whatsapp"></i>
                            <span>WhatsApp</span>
                        </div>
                        <div class="share-option" data-platform="facebook">
                            <i class="fab fa-facebook"></i>
                            <span>Facebook</span>
                        </div>
                        <div class="share-option" data-platform="instagram">
                            <i class="fab fa-instagram"></i>
                            <span>Instagram</span>
                         </div>
                         <div class="share-option" data-platform="copy">
                            <i class="fas fa-copy"></i>
                            <span>Copy Link</span>
                        </div>
                    </div>
                </div>
                <a href="/home" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
            </div>
        </section>

        <!-- Pay Later Confirmation Page - NEWLY ADDED -->
        <section id="pay-later-confirm-page" class="page">
            <div class="msg-box">
                <h2>Order Placed Successfully!</h2>
                <p class="mb-2">Your order has been placed with a <strong class="status-badge status-yellow">Pending Verification</strong> status. Order ID: <strong id="pay-later-order-id-display"></strong>. Please complete your payment offline using the QR code in your downloaded invoice.</p>
                
                <h3 class="mt-2 text-primary">Scan to Pay (Also in your invoice):</h3>
                <img src="https://i.ibb.co/gFP2VQcf/cachesm-qr-1755144422734.jpg" alt="Pay Later QR" class="mb-2 rounded" style="max-width: 200px; margin: 0 auto; display: block;" loading="eager">
                
                <p class="mt-2 text-info">
                    Your order status remains <strong class="status-badge status-yellow">Pending Verification</strong> until manually verified.
                </p>
                <a href="/order" class="mt-2 bg-primary text-white rounded p-1 cursor-pointer" style="display:block; padding: 0.6rem;">Go to My Orders</a>
            </div>
        </section>

        <!-- FAQs Page - NEWLY ADDED -->
        <section id="faqs" class="page">
            <h2 class="section-title">Frequently Asked Questions</h2>
            <div id="faqs-list">
                <!-- FAQs will be rendered here by JS -->
            </div>
        </section>

        <!-- Feedback Page - STRUCTURE MODIFIED -->
        <section id="feedback" class="page">
            <!-- The main form container is now always visible -->
            <div id="feedback-main-form-container">
                 <h2 class="section-title" id="feedback-form-title">ASTROSHRAE FEEDBACK</h2>
                <form id="feedback-form">
                    <input type="hidden" id="feedback-id-input" name="feedbackId">
                    
                    <!-- NEW: Name input for UNREGISTERED USERS ONLY -->
                    <div class="feedback-form-group" id="unregistered-name-group" style="display:none;">
                        <label for="unregistered-user-name">User Name :</label>
                        <input type="text" id="unregistered-user-name" placeholder="Your Name" value="">
                    </div>
                    <!-- END NEW -->

                    <p class="mb-2">We’d love to hear your thoughts! Your feedback helps us serve you better.</p>

                    <div class="feedback-form-group">
                        <label>Which services did you take from Astroshrae?</label>
                        <div class="feedback-options" data-question="q1_services" data-type="checkbox">
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Name Correction"> Name Correction</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Numerology"> Numerology</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Mobilogy"> Mobilogy</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Signature Analysis"> Signature Analysis</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="House Number Analysis"> House Number Analysis</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Vehicle Number Analysis"> Vehicle Number Analysis</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Vedic Remedies"> Vedic Remedies</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Missing Number Remedies"> Missing Number Remedies</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Numero Vastu"> Numero Vastu</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Feng Shui Remedies"> Feng Shui Remedies</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Trigram Therapy"> Trigram Therapy</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Lo Shu Grid & Pa Kua Method"> Lo Shu Grid & Pa Kua Method</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Marriage Compatibility"> Marriage Compatibility</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Date Of Birth Analysis"> Date Of Birth Analysis</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Career Suggestion"> Career Suggestion</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Auspicious Pregnancy Date"> Auspicious Pregnancy Date</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="All Services (without Name correction)"> All Services (without Name correction)</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Zodiac Sign"> Zodiac Sign</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Bracelet Guidance"> Bracelet Guidance</label>
                            <label class="feedback-option"><input type="checkbox" name="q1_services" value="Other"> Other: <input type="text" name="q1_services_other" placeholder="Specify"></label>
                        </div>
                    </div>

                    <div class="feedback-form-group">
                        <label for="q2_feeling">How did you feel about the services you received from Astroshrae? Did you find them helpful, enjoyable, or is there anything you think we could improve? Please share your honest thoughts.</label>
                        <textarea id="q2_feeling" name="q2_feeling" required></textarea>
                    </div>

                    <div class="feedback-form-group">
                        <label>Did you receive your report or remedy on time?</label>
                        <div class="feedback-options" data-question="q3_onTime" data-type="radio">
                            <label class="feedback-option"><input type="radio" name="q3_onTime" value="Yes, perfectly on time" required> Yes, perfectly on time</label>
                            <label class="feedback-option"><input type="radio" name="q3_onTime" value="Slightly delayed"> Slightly delayed</label>
                            <label class="feedback-option"><input type="radio" name="q3_onTime" value="No, it was late"> No, it was late</label>
                            <label class="feedback-option"><input type="radio" name="q3_onTime" value="Other"> Other: <input type="text" name="q3_onTime_other" placeholder="Specify"></label>
                        </div>
                    </div>

                    <div class="feedback-form-group">
                        <label>Was the Numerologist polite and helpful?</label>
                        <div class="feedback-options" data-question="q4_polite" data-type="radio">
                            <label class="feedback-option"><input type="radio" name="q4_polite" value="Very Polite & Helpful" required> Very Polite & Helpful</label>
                            <label class="feedback-option"><input type="radio" name="q4_polite" value="Quite Good"> Quite Good</label>
                            <label class="feedback-option"><input type="radio" name="q4_polite" value="Average"> Average</label>
                            <label class="feedback-option"><input type="radio" name="q4_polite" value="Not really"> Not really</label>
                            <label class="feedback-option"><input type="radio" name="q4_polite" value="Other"> Other: <input type="text" name="q4_polite_other" placeholder="Specify"></label>
                        </div>
                    </div>

                    <div class="feedback-form-group">
                        <label>How useful was the guidance/remedy for you?</label>
                        <div class="feedback-options" data-question="q5_useful" data-type="radio">
                            <label class="feedback-option"><input type="radio" name="q5_useful" value="Super helpful" required> Super helpful</label>
                            <label class="feedback-option"><input type="radio" name="q5_useful" value="Somewhat helpful"> Somewhat helpful</label>
                            <label class="feedback-option"><input type="radio" name="q5_useful" value="Not helpful"> Not helpful</label>
                            <label class="feedback-option"><input type="radio" name="q5_useful" value="Too early to say"> Too early to say</label>
                            <label class="feedback-option"><input type="radio" name="q5_useful" value="Other"> Other: <input type="text" name="q5_useful_other" placeholder="Specify"></label>
                        </div>
                    </div>

                    <div class="feedback-form-group">
                        <label>Was the pricing clear and fair to you?</label>
                        <div class="feedback-options" data-question="q6_pricing" data-type="radio">
                            <label class="feedback-option"><input type="radio" name="q6_pricing" value="Yes, fair and clear" required> Yes, fair and clear</label>
                            <label class="feedback-option"><input type="radio" name="q6_pricing" value="A bit confusing"> A bit confusing</label>
                            <label class="feedback-option"><input type="radio" name="q6_pricing" value="Not at all fair"> Not at all fair</label>
                            <label class="feedback-option"><input type="radio" name="q6_pricing" value="Other"> Other: <input type="text" name="q6_pricing_other" placeholder="Specify"></label>
                        </div>
                    </div>

                    <div class="feedback-form-group">
                        <label>How likely are you to recommend Astroshrae to others?</label>
                        <div class="star-rating" data-question="q7_recommend" data-rating="0">
                            <i class="far fa-star" data-value="1"></i>
                            <i class="far fa-star" data-value="2"></i>
                            <i class="far fa-star" data-value="3"></i>
                            <i class="far fa-star" data-value="4"></i>
                            <i class="far fa-star" data-value="5"></i>
                        </div>
                        <input type="hidden" name="q7_recommend" id="q7_recommend_input" required>
                    </div>

                    <div class="feedback-form-group">
                        <label>Where did you hear about us?</label>
                        <div class="feedback-options" data-question="q8_heardAboutUs" data-type="checkbox">
                            <label class="feedback-option"><input type="checkbox" name="q8_heardAboutUs" value="WhatsApp"> WhatsApp</label>
                            <label class="feedback-option"><input type="checkbox" name="q8_heardAboutUs" value="Instagram"> Instagram</label>
                            <label class="feedback-option"><input type="checkbox" name="q8_heardAboutUs" value="Facebook"> Facebook</label>
                            <label class="feedback-option"><input type="checkbox" name="q8_heardAboutUs" value="Google"> Google</label>
                            <label class="feedback-option"><input type="checkbox" name="q8_heardAboutUs" value="Website"> Website</label>
                            <label class="feedback-option"><input type="checkbox" name="q8_heardAboutUs" value="Other"> Other: <input type="text" name="q8_heardAboutUs_other" placeholder="Specify"></label>
                        </div>
                    </div>

                    <div class="feedback-form-group">
                        <label for="q9_improve">What would you like us to improve or add?</label>
                        <textarea id="q9_improve" name="q9_improve"></textarea>
                    </div>

                    <div class="feedback-form-group">
                        <label>How would you rate your overall experience?</label>
                        <div class="star-rating" data-question="q10_overallRating" data-rating="0">
                            <i class="far fa-star" data-value="1"></i>
                            <i class="far fa-star" data-value="2"></i>
                            <i class="far fa-star" data-value="3"></i>
                            <i class="far fa-star" data-value="4"></i>
                            <i class="far fa-star" data-value="5"></i>
                        </div>
                        <input type="hidden" name="q10_overallRating" id="q10_overallRating_input" required>
                    </div>

                    <div class="feedback-form-group">
                        <label>Would you like to get updates and offers from Astroshrae?</label>
                        <div class="feedback-options" data-question="q11_updates" data-type="radio">
                            <label class="feedback-option"><input type="radio" name="q11_updates" value="Yes, keep me updated!" required> Yes, keep me updated!</label>
                            <label class="feedback-option"><input type="radio" name="q11_updates" value="No, thank you"> No, thank you</label>
                            <label class="feedback-option"><input type="radio" name="q11_updates" value="Other"> Other: <input type="text" name="q11_updates_other" placeholder="Specify"></label>
                        </div>
                    </div>

                    <button type="submit" id="feedback-submit-btn">Submit</button>
                </form>
            </div>
        </section>

        <!-- Reviews Page - NEWLY ADDED -->
        <section id="reviews" class="page">
            <h2 class="section-title">Customer Reviews</h2>
            <div id="reviews-list">
                <!-- Reviews will be rendered here by JS -->
            </div>
        </section>

    </main>

    <!-- Still Need Help? Pop-up - NEWLY ADDED -->
    <div id="help-popup" class="help-popup">
        <p>Still Need Help?</p>
        <div class="help-popup-buttons">
            <a href="https://wa.me/919436906667?text=Hello%20Astroshrae%2C%0AI%20Need%20Help" target="_blank" class="help-chat-btn">Chat With Us</a>
            <a href="tel:+919436906667" class="help-call-btn">Call Us</a>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/home" class="nav-link active" data-target="home"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="/wishlist" class="nav-link" data-target="wishlist"><i class="fas fa-heart"></i><span>Wishlist</span><span class="badge hidden" id="wishlist-badge"></span></a>
        <a href="/cart" class="nav-link" data-target="cart"><i class="fas fa-shopping-cart"></i><span>Cart</span><span class="badge hidden" id="cart-badge"></span></a>
        <a href="/menu" class="nav-link" id="menu-btn" data-target="menu"><i class="fas fa-bars"></i><span>Menu</span></a>
    </nav>

    <!-- Share Modal -->
    <div id="share-modal" class="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-header">
                <h3 id="share-modal-title">Share Product</h3>
                <button class="share-modal-close">&times;</button>
            </div>
            <div class="share-options-grid">
                <div class="share-option" data-platform="whatsapp">
                    <i class="fab fa-whatsapp"></i>
                    <span>WhatsApp</span>
                </div>
                <div class="share-option" data-platform="facebook">
                    <i class="fab fa-facebook"></i>
                    <span>Facebook</span>
                </div>
                <div class="share-option" data-platform="instagram">
                    <i class="fab fa-instagram"></i>
                    <span>Instagram</span>
                </div>
                <div class="share-option" data-platform="snapchat">
                    <i class="fab fa-snapchat"></i>
                    <span>Snapchat</span>
                </div>
                <div class="share-option" data-platform="twitter">
                    <i class="fab fa-twitter"></i>
                    <span>Twitter</span>
                </div>
                <div class="share-option" data-platform="telegram">
                    <i class="fab fa-telegram"></i>
                    <span>Telegram</span>
                </div>
                <div class="share-option" data-platform="sms">
                    <i class="fas fa-sms"></i>
                    <span>SMS</span>
                </div>
                <div class="share-option" data-platform="email">
                    <i class="fas fa-envelope"></i>
                    <span>Email</span>
                </div>
                <div class="share-option" data-platform="copy">
                    <i class="fas fa-copy"></i>
                    <span>Copy Link</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal">
        <div class="content">
            <span class="close" id="login-close">&times;</span>
            <h3 id="login-title">Login</h3>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <p class="mt-1">Don't have an account? <a href="/register" id="switch-to-register">Register</a></p>
        </div>
    </div>

    <div id="register-modal" class="modal">
        <div class="content">
            <span class="close" id="register-close">&times;</span>
            <h3>Register</h3>
            <form id="register-form">
                <input type="text" id="register-name" placeholder="Full Name" required>
                <input type="date" id="register-dob" required>
                <!-- START: NEW FIELDS FOR REGISTER -->
                <input type="text" id="register-pob" placeholder="Your Place Of Birth">
                <input type="time" id="register-tob" placeholder="Your Time Of Birth">
                <!-- END: NEW FIELDS FOR REGISTER -->
                <input type="email" id="register-email" placeholder="Email" required>
                <input type="tel" id="register-phone" placeholder="Phone Number" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button type="submit">Register</button>
            </form>
            <p class="mt-1">Already have an account? <a href="/login" id="switch-to-login">Login</a></p>
        </div>
    </div>

    <div id="checkout-modal" class="modal">
        <div class="content">
            <span class="close" id="checkout-close">&times;</span>
            <h3>Checkout Details</h3>
            <form id="checkout-form">
                <input type="text" id="ship-name" placeholder="Full Name" required>
                <input type="date" id="ship-dob" required>
                <input type="email" id="ship-email" placeholder="Email" required>
                <input type="tel" id="ship-phone" placeholder="Phone Number" required>
                <button type="submit">Select Payment Method</button>
            </form>
        </div>
    </div>

    <div id="payment-method-modal" class="modal">
        <div class="content">
            <span class="close" id="payment-method-close">&times;</span>
            <h3>Select Payment Method</h3>
            <p class="mb-1">All UPI apps (Google Pay, PhonePe, Paytm, BHIM, etc.), Cards, Net Banking, Wallet & EMI options available with "Pay Now".</p>
            <button id="pay-now-btn" class="bg-primary text-white rounded p-1 mb-1 cursor-pointer">Pay Now (Razorpay)</button>
            <button id="pay-later-modal-btn" class="bg-success text-white rounded p-1 cursor-pointer">Pay Later (Place Order as Pending)</button>
        </div>
    </div>

    <div id="order-edit-modal" class="modal">
        <div class="content">
            <span class="close" id="order-edit-close">&times;</span>
            <h3>Edit Order Details (Pending)</h3>
            <form id="order-edit-form">
                <input type="text" id="edit-name" placeholder="Full Name" required>
                <input type="date" id="edit-dob" required>
                <input type="tel" id="edit-phone" placeholder="Phone Number" required>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="profile-edit-modal" class="modal">
        <div class="content">
            <span class="close" id="profile-edit-close">&times;</span>
            <h3>Edit Account Details</h3>
            <form id="profile-edit-form">
                <input type="text" id="profile-edit-name" placeholder="Full Name" required>
                <input type="date" id="profile-edit-dob" required>
                 <!-- START: ADDED POB/TOB TO PROFILE EDIT -->
                <input type="text" id="profile-edit-pob" placeholder="Your Place Of Birth">
                <input type="time" id="profile-edit-tob" placeholder="Your Time Of Birth">
                <!-- END: ADDED POB/TOB TO PROFILE EDIT -->
                <input type="tel" id="profile-edit-phone" placeholder="Phone Number" required>
                <button type="submit">Update Profile</button>
            </form>
        </div>
    </div>

    <div id="menu-modal" class="modal">
        <div class="content">
            <span class="close" id="menu-close">&times;</span>
            <h3>Menu</h3>
            <ul id="menu-list">
                <li><a href="/home" class="menu-link">Home</a></li>
                <li><a href="/order" class="menu-link">My Orders</a></li>
                <li><a href="/profile" class="menu-link">Profile</a></li>
                <li><a href="/feedback" class="menu-link">Feedback</a></li>
                <li><a href="/reviews" class="menu-link">Reviews</a></li>
                <li><a href="/about" class="menu-link">About Us</a></li>
                <li><a href="/contact" class="menu-link">Contact Us</a></li>
                <li><a href="/faqs" class="menu-link">FAQs</a></li>
                <li><a href="/terms" class="menu-link">Terms & Conditions</a></li>
                <li><a href="/privacy" class="menu-link">Privacy Policy</a></li>
                <li id="menu-login-logout"><a href="/login" class="menu-link">Login</a></li>
            </ul>
        </div>
    </div>

    <div id="order-details-modal" class="modal">
        <div class="content">
            <span class="close" id="order-details-close">&times;</span>
            <h3>Order Details</h3>
            <div id="order-details-content"></div>
            <div class="flex justify-between mt-2">
                <button id="download-order-json" class="bg-primary order-btn">Download Order (JSON)</button>
                <button id="download-order-invoice" class="bg-success order-btn">Download Invoice (HTML)</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script type="module">
        // Firebase v9 modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, child, get, remove, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD1fl7RoC6Ed3vUfQ0-Y5Uvk-24euWq-SA",
            authDomain: "astroshrae-1.firebaseapp.com",
            databaseURL: "https://astroshrae-1-default-rtdb.firebaseio.com",
            projectId: "astroshrae-1",
            storageBucket: "astroshrae-1.firebasestorage.app",
            messagingSenderId: "816074093623",
            appId: "1:816074093623:web:0da8c74561070f9f7d7bb2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // EmailJS init
        emailjs.init("O0aRcS_ccNgXBkQv0"); // Replace with your actual EmailJS User ID
        

        // Global state
        let currentUser = null;
        let products = []; // All products from DB
        let categories = []; // Unique categories
        let cart = {}; // {productId:{quantity,name,price,image}}
        let wishlist = {}; // {productId:{name,price,image}}
        let userProfile = {}; // Stores current user's profile data

        // Renamed from TAX_AMOUNT to TRANSACTION_FEES_FLAT_AMOUNT as per requirement
        // This fee is only applied if "Pay Now" is selected.
        const TRANSACTION_FEES_FLAT_AMOUNT = 0.05; // Fixed ₹0.05 transaction fee

        const RAZORPAY_KEY = "rzp_live_R8n7NXIgrsHpmo"; // Your Razorpay Live Key
        const RAZORPAY_SECRET = "r5bVYQ09Vc0wlGLsoGAu3eSL"; 
        const RAZORPAY_MERCHANT_ID = "R2IgZL9M1BmqEt"; // Your Razorpay Merchant ID
        let pendingOrderId = null; // Order ID being processed or awaiting payment (for re-payment or Pay Later)
        let pendingOrderData = null; // Temp data for Pay-Later flow or re-payment
        let editingOrderId = null; // Order being edited (Pending only)
        let currentProductForShare = null; // Current product for sharing
        let toastTimeout = null; // Timeout reference for toast
        let appliedCoupon = null; // Currently applied coupon object {code, type, value, usageCount, minOrder}
        let currentFeedbackIdForEdit = null; // Stores the ID of the feedback being edited

        // Utility helpers
        const $ = sel => document.querySelector(sel);
        const $$ = sel => document.querySelectorAll(sel);
        const fmt = n => `₹${Number(n).toFixed(2)}`; // Formats number to Indian Rupee with 2 decimal places
        const toast = (msg, type = "success", actions = []) => {
            const t = $("#toast");
            if (toastTimeout) {
                clearTimeout(toastTimeout);
                toastTimeout = null;
            }
            t.className = `toast bg-${type}`; // Use type for background color (success, danger, info etc.)
            t.innerHTML = `<span>${msg}</span>`;
            actions.forEach(a => {
                const b = document.createElement("button");
                b.textContent = a.label;
                b.onclick = a.onClick;
                t.appendChild(b);
            });
            const closeBtn = document.createElement("button");
            closeBtn.innerHTML = "✖";
            closeBtn.onclick = () => {
                t.style.display = "none";
                if (toastTimeout) {
                    clearTimeout(toastTimeout);
                    toastTimeout = null;
                }
            };
            t.appendChild(closeBtn);
            t.style.display = "flex";
            toastTimeout = setTimeout(() => {
                t.style.display = "none";
                toastTimeout = null;
            }, 4000);
        };

        const showLoading = (msg = "Processing…") => {
            $("#loading-overlay").classList.add("active");
        };

        const hideLoading = () => {
            $("#loading-overlay").classList.remove("active");
        };

        const openModal = id => $(id).classList.add("active");
        const closeModal = id => $(id).classList.remove("active");

        // Order ID generator – single counter
        const generateOrderId = async () => {
            const cntRef = ref(db, "orderCounter");
            let next;
            await runTransaction(cntRef, currentVal => {
                if (currentVal === null) {
                    next = 100; // Start from 100
                } else {
                    next = currentVal + 1;
                }
                return next;
            });
            return `AST-${next}`; // e.g. AST-101
        };

        // Store order in three places for robust data management
        const storeOrderInAllPlaces = async orderData => {
            const uid = currentUser ? currentUser.uid : "guest"; // Should ideally always be a user for payment flows
            const orderToStore = { ...orderData };

            try {
                // 1️⃣ user-specific node
                const userRef = ref(db, `orders/${uid}/${orderData.orderId}`);
                await set(userRef, orderToStore);
                // 2️⃣ global node for admin view
                const globalRef = ref(db, `globalOrders/${orderData.orderId}`);
                await set(globalRef, orderToStore);
                // 3️⃣ clean "orderDetails" node (exact fields you asked for)
                const detailsRef = ref(db, `orderDetails/${orderData.orderId}`);
                await set(detailsRef, orderToStore);
                return true;
            } catch (error) {
                console.error("Error storing order in Firebase:", error);
                return false;
            }
        };

        // Create order record – builds a flat order object and writes it
        const createOrderRecord = async orderObj => {
            try {
                const orderId = orderObj.orderId || await generateOrderId(); // Use existing ID if provided (for re-payment)
                const flatOrder = {
                    orderId,
                    timestamp: Date.now(),
                    status: orderObj.status || "Pending", // Firebase system status (Completed, Pending Verification, Pending, Cancelled)
                    paymentMethod: orderObj.paymentMethod || "Not Specified",
                    totalAmount: orderObj.totalAmount || 0,
                    discountAmount: orderObj.discountAmount || 0,
                    couponCode: orderObj.couponCode || "", 
                    transactionId: orderObj.transactionId || "", 
                    transactionFeesAmount: orderObj.transactionFeesAmount || 0, 
                    name: orderObj.shipping?.name || "",
                    dob: orderObj.shipping?.dob || "",
                    email: orderObj.shipping?.email || "",
                    phone: orderObj.shipping?.phone || "",
                    selectedServices: (orderObj.items || []).map(i => ({
                        productId: i.productId,
                        serviceName: i.name || "Unnamed Service",
                        quantity: i.quantity || 1,
                        price: i.price || 0
                    })),
                    adminPaymentStatus: orderObj.adminPaymentStatus || null,
                    adminPaymentStatusCustomValue: null,
                    adminOrderStatus: orderObj.adminOrderStatus || null,
                    adminOrderStatusCustomValue: null,
                };
                const storedSuccessfully = await storeOrderInAllPlaces(flatOrder);
                if (storedSuccessfully) {
                    pendingOrderId = orderId; 
                    pendingOrderData = flatOrder; 
                    return flatOrder;
                } else {
                    throw new Error("Failed to store order in database.");
                }
            } catch (error) {
                console.error("Error creating order record:", error);
                throw error;
            }
        };

        // Function to derive payment and order status for display in User Panel - UPDATED LOGIC
        const deriveStatuses = (order) => {
            let paymentStatus = "Unknown";
            let orderStatus = "Unknown";

            if (order.adminPaymentStatus === "Custom" && order.adminPaymentStatusCustomValue) {
                paymentStatus = order.adminPaymentStatusCustomValue;
            } else if (order.adminPaymentStatus && order.adminPaymentStatus !== "Custom") {
                paymentStatus = order.adminPaymentStatus;
            } else {
                if (order.status === "Completed") {
                    paymentStatus = "Paid";
                } else if (order.status === "Pending Verification" && order.paymentMethod === "Pay Later") {
                    paymentStatus = "Pending Verification";
                } else if (order.status === "Pending") {
                    if (order.paymentMethod === "Pay Later") {
                        paymentStatus = "Pending Payment"; 
                    } else if (order.paymentMethod === "Payment Failed/Cancelled") {
                        paymentStatus = "Payment Failed"; 
                    } else { 
                        paymentStatus = "Pending Payment";
                    }
                } else if (order.status === "Cancelled") {
                    paymentStatus = "Cancelled";
                } else if (order.paymentMethod === "Zero Amount Order") { 
                    paymentStatus = "Paid";
                }
            }

            if (order.adminOrderStatus === "Custom" && order.adminOrderStatusCustomValue) {
                orderStatus = order.adminOrderStatusCustomValue;
            } else if (order.adminOrderStatus && order.adminOrderStatus !== "Custom") {
                orderStatus = order.adminOrderStatus;
            } else {
                if (order.paymentMethod === "Pay Now" && order.status === "Completed") {
                    orderStatus = "Pending";
                } else if (order.status === "Completed") {
                    orderStatus = "In Progress";
                } else if (order.status === "Pending Verification") {
                    orderStatus = "Pending";
                } else if (order.status === "Pending") {
                    orderStatus = "Pending";
                } else if (order.status === "Cancelled") {
                    orderStatus = "Cancelled";
                } else if (order.paymentMethod === "Zero Amount Order") {
                    orderStatus = "In Progress";
                }
            }

            return { paymentStatus, orderStatus };
        };

        // Send order confirmation email using EmailJS
        const sendConfirmationEmail = async (orderData) => {
            const { paymentStatus, orderStatus } = deriveStatuses(orderData); 
            const serviceList = orderData.selectedServices.map(s => 
                `- ${s.serviceName} (Qty: ${s.quantity}) - ${fmt(s.price * s.quantity)}`
            ).join('\n');
            
            let discountDetails = "";
            if (orderData.discountAmount > 0) {
                discountDetails = `Discount (Coupon: ${orderData.couponCode || 'N/A'}): -${fmt(orderData.discountAmount)}`;
            }
            let subtotalAmount = orderData.selectedServices.reduce((acc, s) => acc + (s.price * s.quantity), 0);
            const templateParams = {
                to_name: orderData.name,
                to_email: orderData.email,
                order_id: orderData.orderId,
                order_date: new Date(orderData.timestamp).toLocaleDateString('en-IN'), 
                customer_name: orderData.name, 
                customer_email: orderData.email,
                customer_phone: orderData.phone,
                customer_dob: orderData.dob,
                services_ordered: serviceList,
                subtotal: fmt(subtotalAmount),
                discount_details: discountDetails, 
                total_amount: fmt(orderData.totalAmount),
                payment_method: orderData.paymentMethod,
                payment_status: paymentStatus, 
                order_status: orderStatus, 
                contact_email: "astroshrae1@gmail.com",
                contact_phone: "+919436906667"
            };

            try {
                await emailjs.send('service_s5n39z8', 'template_56k148v', templateParams); 
                console.log('Order confirmation email sent successfully!');
            } catch (error) {
                console.error('Failed to send order confirmation email:', error);
            }
        };

        // Send order confirmation via WhatsApp - UPDATED MESSAGE CONTENT AND STATUSES
        const sendWhatsAppOrderConfirmation = (orderData) => {
            const { paymentStatus, orderStatus } = deriveStatuses(orderData); 
            const serviceList = orderData.selectedServices.map(s => 
                `- ${s.serviceName} (Qty: ${s.quantity}) - ${fmt(s.price * s.quantity)}`
            ).join('\n');
            
            let discountLine = "";
            if (orderData.discountAmount > 0) {
                discountLine = `Discount ${orderData.couponCode ? `(Coupon: ${orderData.couponCode})` : ''}: -${fmt(orderData.discountAmount)}\n`;
            }
            
            let subtotalAmount = orderData.selectedServices.reduce((acc, s) => acc + (s.price * s.quantity), 0);
            const whatsappMessage = `*Order Confirmation from Astroshrae!* ✨
*Order ID:* ${orderData.orderId}
*Date:* ${new Date(orderData.timestamp).toLocaleDateString('en-IN')}

*Customer Details:*
👤 Name: ${orderData.name}
📧 Email: ${orderData.email}
📞 Phone: ${orderData.phone}
🗓️ DOB: ${orderData.dob}

*Services Ordered:*
${serviceList}

*Summary:*
Subtotal: ${fmt(subtotalAmount)}
${discountLine}Total: ${fmt(orderData.totalAmount)}

*Payment Status:* ${paymentStatus}
*Order Status:* ${orderStatus}
*Payment Method:* ${orderData.paymentMethod}

Thank you for choosing Astroshrae! We're excited to assist you on your spiritual journey.
If you have any questions, feel free to reply to this message.

🌐 *Website:* ${window.location.origin}/home
📧 *Email:* astroshrae1@gmail.com
📞 *Contact:* +919436906667`;

            const astroshraePhoneNumber = "919436906667"; 
            const whatsappUrl = `https://wa.me/${astroshraePhoneNumber}?text=${encodeURIComponent(whatsappMessage)}`;
            // Directly redirect to WhatsApp without confirmation
            window.open(whatsappUrl, '_blank');
        };

        const calculateCartTotal = () => {
            let subtotal = 0;
            Object.values(cart).forEach(i => subtotal += i.price * i.quantity);
            let discount = 0;
            if (appliedCoupon) {
                if (Object.keys(cart).length > 0 && (!appliedCoupon.minOrder || subtotal >= appliedCoupon.minOrder)) {
                    if (appliedCoupon.type === 'percentage') {
                        discount = (subtotal * appliedCoupon.value / 100);
                    } else if (appliedCoupon.type === 'fixed') {
                        discount = appliedCoupon.value;
                    }
                    discount = Math.min(discount, subtotal);
                } else if (appliedCoupon.minOrder && subtotal < appliedCoupon.minOrder) {
                    $("#coupon-message").textContent = `Coupon "${appliedCoupon.code}" is only valid for orders of ${fmt(appliedCoupon.minOrder)} or more.`;
                    $("#coupon-message").className = "coupon-message coupon-error";
                    appliedCoupon = null; 
                    $("#coupon-code").value = "";
                }
            }
            const total = subtotal - discount;
            return { subtotal, discount, total: Math.max(0, total) };
        };

        const updateBadges = () => {
            const cartCount = Object.values(cart).reduce((a,i)=>a+i.quantity,0);
            const wishCount = Object.keys(wishlist).length;
            $("#cart-badge").textContent = cartCount;
            $("#wishlist-badge").textContent = wishCount;
            $("#cart-badge").classList.toggle("hidden", cartCount===0);
            $("#wishlist-badge").classList.toggle("hidden", wishCount===0);
        };

        const validateShippingDetails = () => {
            const name = $("#ship-name").value.trim();
            const dob = $("#ship-dob").value.trim();
            const email = $("#ship-email").value.trim();
            const phone = $("#ship-phone").value.trim();
            if (!name || !dob || !email || !phone) {
                toast("Please fill all shipping details.", "danger");
                return false;
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                toast("Invalid email address.", "danger");
                return false;
            }
            const phoneRegex = /^\d{10,15}$/;
            if (!phoneRegex.test(phone)) {
                toast("Phone number must be 10-15 digits.", "danger");
                return false;
            }
            if (Object.keys(cart).length===0) {
                toast("Your cart is empty.", "danger");
                return false;
            }
            return true;
        };
        
        const sanitizeProductNameForUrl = (name) => {
            // Converts "Name Correction" to "name-correction"
            return name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-'); 
        };

        const renderCategories = () => {
            const cDiv = $("#category-list");
            cDiv.innerHTML = "";
            const all = document.createElement("div");
            all.className = "category active";
            all.textContent = "All";
            all.dataset.cat = "All";
            cDiv.appendChild(all);
            categories.forEach(cat => {
                const d = document.createElement("div");
                d.className = "category";
                d.textContent = cat;
                d.dataset.cat = cat;
                cDiv.appendChild(d);
            });
            $$(".category").forEach(el => {
                el.onclick = () => {
                    $$(".category").forEach(c=>c.classList.remove("active"));
                    el.classList.add("active");
                    renderProducts(el.dataset.cat);
                };
            });
        };

        // NEW: Function to render skeleton placeholders
        const renderSkeletonProducts = (count = 6) => {
            const grid = $("#product-grid");
            grid.innerHTML = ""; // Clear previous content
            for (let i = 0; i < count; i++) {
                const card = document.createElement("div");
                card.className = "product-card";
                card.innerHTML = `
                    <div class="skeleton skeleton-image"></div>
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-price"></div>
                    <div class="skeleton skeleton-button"></div>
                `;
                grid.appendChild(card);
            }
        };

        const renderProducts = (filter = "All") => {
            const grid = $("#product-grid");
            grid.innerHTML = "";
            const list = filter==="All"?products:products.filter(p=>p.category===filter);
            list.forEach(p => {
                const card = document.createElement("div");
                card.className = "product-card";
                const heart = wishlist[p.id] ? "❤️" : "🖤";
                
                const productUrlPath = `/product/${sanitizeProductNameForUrl(p.name)}`;
                
                card.innerHTML = `
                    <a href="${productUrlPath}" style="text-decoration:none; color:inherit;">
                        <div class="product-image-container">
                            <img src="${p.imageUrl}" alt="${p.name}" loading="lazy">
                            <div class="share-icon" data-id="${p.id}">
                                <i class="fas fa-share-alt"></i>
                            </div>
                        </div>
                        <h4>${p.name}</h4>
                    </a>
                    <p class="price">${fmt(p.price)}</p>
                    <div class="actions">
                        <button class="add-cart" data-id="${p.id}">Add to Cart</button>
                        <span class="wishlist" data-id="${p.id}">${heart}</span>
                    </div>
                    <a href="${productUrlPath}" class="view-details-btn" data-id="${p.id}">View Details</a>
                `;

                card.querySelector(".add-cart").onclick = (e)=>{e.stopPropagation(); addToCart(p);};
                const wishSpan = card.querySelector(".wishlist");
                wishSpan.onclick = (e)=>{e.stopPropagation(); toggleWishlist(p); wishSpan.textContent = wishlist[p.id] ? "❤️" : "🖤";};
                const shareIcon = card.querySelector(".share-icon");
                shareIcon.onclick = (e)=>{e.stopPropagation(); e.preventDefault(); openShareModal(p);};

                grid.appendChild(card);
            });
        };

        const renderProductPreview = (product) => {
            if (!product) {
                navigateTo("/home");
                toast("Product not found.", "danger");
                return;
            }
            $("#preview-title").textContent = product.name;
            $("#preview-price").textContent = fmt(product.price);
            $("#preview-image").src = product.imageUrl;
            $("#preview-description").innerHTML = product.description || "No description available.";
            $("#preview-add-cart").onclick = () => {
                addToCart(product);
                toast("Item added to cart");
            };
            const wishlistBtn = $("#preview-add-wishlist");
            const isInWishlist = wishlist[product.id];
            wishlistBtn.innerHTML = isInWishlist ? 
                '<i class="fas fa-heart" style="color:red"></i> Remove from Wishlist' : 
                '<i class="fas fa-heart"></i> Add to Wishlist';
            wishlistBtn.onclick = () => {
                toggleWishlist(product);
                const nowInWishlist = wishlist[product.id];
                wishlistBtn.innerHTML = nowInWishlist ? 
                    '<i class="fas fa-heart" style="color:red"></i> Remove from Wishlist' : 
                    '<i class="fas fa-heart"></i> Add to Wishlist';
                toast(nowInWishlist ? "Added to wishlist" : "Removed from wishlist");
            };
            $$("#product-preview .share-option").forEach(option => {
                option.onclick = (e) => {
                    e.preventDefault();
                    shareProduct(option.dataset.platform, product);
                };
            });
            $$(".page").forEach(p => p.classList.remove("active"));
            $("#product-preview").classList.add("active");
            $$(".bottom-nav a").forEach(a => a.classList.remove("active"));
        };

        const openShareModal = (product) => {
            currentProductForShare = product;
            $("#share-modal-title").textContent = `Share ${product.name}`;
            openModal("#share-modal");
            $$("#share-modal .share-option").forEach(option => {
                option.onclick = (e) => {
                    e.preventDefault();
                    shareProduct(option.dataset.platform, product);
                };
            });
        };

        const shareProduct = (platform, product) => {
            const productUrl = `${window.location.origin}/product/${sanitizeProductNameForUrl(product.name)}`;
            const message = `*Astroshrae Recommendation!* ✨

I found this amazing service on Astroshrae that I think you'd love:

*🔮 ${product.name} - ${fmt(product.price)}*
${product.description.substring(0, 150).replace(/<[^>]*>/g, '')}... *(view full details on site)*

*👉 Check It Out Here:* ${productUrl} 

🌟 Unlock Cosmic Guidance With Trusted Numerology Services! 🌟

📞 *Contact:* +91 9436906667 
📧 *Email:* astroshrae1@gmail.com 
🌐 *Website:* ${window.location.origin}/home`;
            let shareUrl;
            switch(platform) {
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                    break;
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productUrl)}&quote=${encodeURIComponent(message)}`;
                    break;
                case 'instagram':
                case 'snapchat':
                    navigator.clipboard.writeText(message).then(() => {
                        toast(`Message copied to clipboard! Paste it in ${platform === 'instagram' ? 'Instagram' : 'Snapchat'}.`);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        toast("Failed to copy link. Please copy manually.", "danger");
                    });
                    closeModal("#share-modal");
                    return;
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
                    break;
                case 'telegram':
                    shareUrl = `https://t.me/share/url?url=${encodeURIComponent(productUrl)}&text=${encodeURIComponent(message)}`;
                    break;
                case 'sms':
                    shareUrl = `sms:?body=${encodeURIComponent(message)}`;
                    break;
                case 'email':
                    shareUrl = `mailto:?subject=${encodeURIComponent(`Astroshrae: ${product.name}`)}&body=${encodeURIComponent(message)}`;
                    break;
                case 'copy':
                    navigator.clipboard.writeText(message).then(() => {
                        toast("Link and message copied to clipboard!");
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        toast("Failed to copy link. Please copy manually.", "danger");
                    });
                    closeModal("#share-modal");
                    return;
                default:
                    return;
            }
            window.open(shareUrl, '_blank');
            closeModal("#share-modal");
        };

        const addToCart = product => {
            if (!currentUser) {
                const local = JSON.parse(localStorage.getItem("guest_cart")||"{}");
                if (local[product.id]) {
                    local[product.id].quantity += 1;
                } else {
                    local[product.id] = {
                        quantity: 1,
                        name: product.name,
                        price: product.price,
                        image: product.imageUrl
                    };
                }
                localStorage.setItem("guest_cart", JSON.stringify(local));
                cart = local;
                renderCart();
                updateBadges();
                toast("Item added to cart", "success", [
                    {label:"Go To Cart", onClick:()=>{navigateTo('/cart');}},
                    {label:"Continue Shopping", onClick:()=>{}}
                ]);
                return;
            }
            const uid = currentUser.uid;
            const refPath = `users/${uid}/cart/${product.id}`;
            runTransaction(ref(db, refPath), cur => {
                if (cur===null) {
                    return {
                        quantity:1,
                        name:product.name,
                        price:product.price,
                        image:product.imageUrl
                    };
                }
                cur.quantity += 1;
                return cur;
            }).then(() => {
                toast("Item added to cart", "success", [
                    {label:"Go To Cart", onClick:()=>{navigateTo('/cart');}},
                    {label:"Continue Shopping", onClick:()=>{}}
                ]);
            }).catch(e => {
                console.error(e);
                toast("Failed to add to cart", "danger");
            });
        };

        const toggleWishlist = product => {
            if (!currentUser) {
                const local = JSON.parse(localStorage.getItem("guest_wishlist")||"{}");
                if (local[product.id]) {
                    delete local[product.id];
                    toast("Item removed from wishlist");
                } else {
                    local[product.id] = {
                        name:product.name,
                        price:product.price,
                        image:product.imageUrl
                    };
                    toast("Your item is added to wishlist");
                }
                localStorage.setItem("guest_wishlist", JSON.stringify(local));
                wishlist = local;
                renderWishlist();
                updateBadges();
                document.querySelectorAll(`.wishlist[data-id="${product.id}"]`).forEach(icon => {
                    icon.textContent = wishlist[product.id] ? "❤️" : "🖤";
                });
                return;
            }
            const uid = currentUser.uid;
            const wRef = ref(db, `users/${uid}/wishlist/${product.id}`);
            if (wishlist[product.id]) {
                remove(wRef);
                toast("Item removed from wishlist");
            } else {
                set(wRef, {
                    name:product.name,
                    price:product.price,
                    image:product.imageUrl
                });
                toast("Your item is added to wishlist");
            }
        };

        const renderCart = () => {
            const list = $("#cart-list");
            list.innerHTML = "";
            if (Object.keys(cart).length===0) {
                list.innerHTML = "<p>Your cart is empty.</p>";
                $("#checkout-btn").disabled = true;
                $("#cart-subtotal").textContent = fmt(0);
                $("#cart-discount").textContent = `- ${fmt(0)}`;
                $("#cart-total").textContent = fmt(0);
                $("#coupon-message").textContent = "";
                $("#coupon-message").className = "coupon-message";
                appliedCoupon = null;
                $("#coupon-code").value = "";
                return;
            }
            Object.entries(cart).forEach(([pid,item]) => {
                const row = document.createElement("div");
                row.className = "flex justify-between align-center mb-1 p-1 rounded bg-light";
                row.innerHTML = `
                    <div class="flex align-center">
                        <img src="${item.image}" alt="${item.name}" style="width:40px;height:40px;margin-right:.5rem;" loading="lazy">
                        <span>${item.name}</span>
                    </div>
                    <div class="flex align-center">
                        <button class="quantity-btn" data-id="${pid}" data-act="dec">-</button>
                        <span>${item.quantity}</span>
                        <button class="quantity-btn" data-id="${pid}" data-act="inc">+</button>
                    </div>
                    <div>${fmt(item.price * item.quantity)}</div>
                    <button class="p-0 text-danger" data-id="${pid}" data-act="rem" style="background:none;border:none;width:auto;font-size:1.2rem;padding:0.2rem;"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(row);
            });
            list.querySelectorAll("button[data-act]").forEach(btn => {
                btn.onclick = () => {
                    if (!currentUser) {
                        toast("Please login to manage cart.", "info");
                        openModal("#login-modal");
                        return;
                    }
                    const pid = btn.dataset.id;
                    const act = btn.dataset.act;
                    const uid = currentUser.uid;
                    const itemRef = ref(db, `users/${uid}/cart/${pid}`);
                    if (act==="inc") {
                        runTransaction(itemRef, cur=>{
                            if(cur) cur.quantity+=1;
                            return cur;
                        }).catch(e => console.error("Error incrementing quantity:", e));
                    } else if (act==="dec") {
                        runTransaction(itemRef, cur=>{
                            if(cur && cur.quantity>1){
                                cur.quantity-=1;
                            } else if (cur && cur.quantity === 1) {
                                return null;
                            }
                            return cur;
                        }).catch(e => console.error("Error decrementing quantity:", e));
                    } else if (act==="rem") {
                        remove(itemRef)
                            .then(() => toast("Item removed from cart"))
                            .catch(e => { console.error("Error removing item:", e); toast("Failed to remove item", "danger"); });
                    }
                };
            });
            const totals = calculateCartTotal();
            $("#cart-subtotal").textContent = fmt(totals.subtotal);
            if (totals.discount > 0) {
                $("#cart-discount").textContent = `- ${fmt(totals.discount)}`;
            } else {
                $("#cart-discount").textContent = `- ${fmt(0)}`;
            }
            
            $("#cart-total").textContent = fmt(totals.total);
            $("#checkout-btn").disabled = false;
        };

        const renderWishlist = () => {
            const list = $("#wishlist-list");
            list.innerHTML = "";
            if (Object.keys(wishlist).length===0) {
                list.innerHTML = "<p>Your wishlist is empty.</p>";
                return;
            }
            Object.entries(wishlist).forEach(([pid,item]) => {
                const row = document.createElement("div");
                row.className = "flex justify-between align-center mb-1 p-1 rounded bg-light";
                row.innerHTML = `
                    <div class="flex align-center">
                        <img src="${item.image}" alt="${item.name}" style="width:40px;height:40px;margin-right:.5rem;" loading="lazy">
                        <span>${item.name}</span>
                    </div>
                    <div>${fmt(item.price)}</div>
                    <div class="wishlist-action">
                        <button class="move-to-cart" data-id="${pid}" data-act="move"><i class="fas fa-cart-plus"></i> Move to Cart</button>
                        <button class="remove-wishlist" data-id="${pid}" data-act="rem"><i class="fas fa-trash"></i> Remove</button>
                    </div>
                `;
                list.appendChild(row);
            });
            list.querySelectorAll("button[data-act]").forEach(btn => {
                btn.onclick = () => {
                    if (!currentUser) {
                        toast("Please login to manage wishlist.", "info");
                        openModal("#login-modal");
                        return;
                    }
                    const pid = btn.dataset.id;
                    const act = btn.dataset.act;
                    const uid = currentUser.uid;
                    if (act==="move") {
                        const prod = products.find(p=>p.id===pid);
                        if (prod) {
                            addToCart(prod);
                            remove(ref(db, `users/${uid}/wishlist/${pid}`))
                                .catch(e => { console.error("Error moving to cart from wishlist:", e); toast("Failed to move to cart", "danger"); });
                        } else {
                            toast("Product not found to move to cart.", "danger");
                        }
                    } else if (act==="rem") {
                        remove(ref(db, `users/${uid}/wishlist/${pid}`))
                            .then(() => toast("Item removed from wishlist"))
                            .catch(e => { console.error("Error removing from wishlist:", e); toast("Failed to remove item", "danger"); });
                    }
                };
            });
        };

        const renderOrders = snap => {
            const list = $("#orders-list");
            list.innerHTML = "";
            if (!snap.exists()) {
                list.innerHTML = "<p>No orders placed yet.</p>";
                return;
            }
            const orders = snap.val();
            Object.values(orders).reverse().forEach(o => {
                const { paymentStatus, orderStatus } = deriveStatuses(o);
                const statusClassMap = {
                    "Pending Payment": "status-red",
                    "Payment Failed": "status-red",
                    "Pending Verification": "status-yellow",
                    "Paid": "status-deep-green",
                    "Pending": "status-yellow",
                    "In Progress": "status-light-green",
                    "Completed": "status-deep-green",
                    "Cancelled": "status-red",
                    "N/A": "status-grey",
                    "Unknown": "status-blue"
                };
                const paymentStatusClass = statusClassMap[paymentStatus] || "status-blue";
                const orderStatusClass = statusClassMap[orderStatus] || "status-blue";
                const div = document.createElement("div");
                div.className = "order-box"; 
                div.innerHTML = `
                    <strong>Order ID:</strong> ${o.orderId}<br>
                    <strong>Date:</strong> ${new Date(o.timestamp).toLocaleString()}<br>
                    <strong>Total:</strong> ${fmt(o.totalAmount)}<br>
                    <strong>Payment Status:</strong> <span class="status-badge ${paymentStatusClass}">${paymentStatus}</span><br>
                    <strong>Order Status:</strong> <span class="status-badge ${orderStatusClass}">${orderStatus}</span><br>
                    <strong>Payment Method:</strong> ${o.paymentMethod}<br>
                    <strong>Customer:</strong> ${o.name} (${o.email})<br>
                    <strong>Phone:</strong> ${o.phone}<br>
                    <strong>DOB:</strong> ${o.dob}<br>
                    <strong>Selected Services:</strong> ${o.selectedServices.map(s=>s.serviceName + " (x"+s.quantity+")").join(", ")}<br>
                    <button class="order-btn btn-details mt-1">Details</button>
                    ${(paymentStatus === "Pending Payment" || paymentStatus === "Payment Failed" || paymentStatus === "Pending Verification") ? '<button class="order-btn btn-pay-now mt-1" data-order-id="' + o.orderId + '">Pay Now</button>' : ''}
                    ${(orderStatus === "Pending") ? '<button class="order-btn btn-edit mt-1">Edit</button>' : ''}
                `;
                div.querySelector(".btn-details").onclick = () => openOrderDetails(o);
                const payNowBtn = div.querySelector(".btn-pay-now");
                if (payNowBtn) {
                    payNowBtn.onclick = () => {
                        pendingOrderId = o.orderId;
                        pendingOrderData = o;
                        openModal("#payment-method-modal");
                    };
                }
                const editBtn = div.querySelector(".btn-edit");
                if (editBtn) {
                    editBtn.onclick = () => openOrderEditModal(o);
                }
                list.appendChild(div);
            });
        };

        const openOrderDetails = order => {
            const content = $("#order-details-content");
            const itemsRows = order.selectedServices.map(s=>
                `<tr><td>${s.serviceName}</td><td>${s.quantity}</td><td>${fmt(s.price * s.quantity)}</td></tr>`
            ).join("");
            
            const { paymentStatus, orderStatus } = deriveStatuses(order);
            const qrCodeInInvoice = order.paymentMethod.startsWith("Pay Later") ? `
                <p class="center mt-2"><strong>Payment QR Code:</strong></p>
                <img src="https://i.ibb.co/gFP2VQcf/cachesm-qr-1755144422734.jpg" style="width:100px; height:100px; display:block; margin: 10px auto; border: 1px solid #eee; padding: 5px; border-radius: 8px;" alt="QR Code" loading="eager">
                <p class="center text-info">Please scan to complete your payment. Your order status will be updated after manual verification.</p>
            ` : '';
            const discountRow = order.discountAmount > 0 ? `
                <p class="mt-1"><strong>Discount (Coupon: ${order.couponCode || 'N/A'}):</strong> - ${fmt(order.discountAmount)}</p>` : '';
            const transactionFeesRow = order.transactionFeesAmount > 0 ? `
                 <p class="mt-1"><strong>Transaction Fees:</strong> ${fmt(order.transactionFeesAmount)}</p>
            ` : '';
            content.innerHTML = `
                <p><strong>Order ID:</strong> ${order.orderId||'N/A'}</p>
                <p><strong>Date:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
                <p><strong>Payment Method:</strong> ${order.paymentMethod||'N/A'}</p>
                <p><strong>Payment Status:</strong> ${paymentStatus}</p>
                <p><strong>Order Status:</strong> ${orderStatus}</p>
                <p><strong>Total Amount:</strong> ${fmt(order.totalAmount||0)}</p>
                <h4>Customer Details</h4>
                <p>Name: ${order.name||'N/A'}</p>
                <p>DOB: ${order.dob||'N/A'}</p>
                <p>Email: ${order.email||'N/A'}</p>
                <p>Phone: ${order.phone||'N/A'}</p>
                <h4>Selected Services</h4>
                <table style="width:100%; text-align:left;"><thead><tr><th>Service</th><th>Qty</th><th>Price</th></tr></thead>
                <tbody>${itemsRows || '<tr><td colspan="3">No services.</td></tr>'}</tbody></table>
                ${discountRow}
                ${transactionFeesRow}
                ${qrCodeInInvoice}
            `;
            $("#download-order-json").onclick = () => exportOrderData(order);
            $("#download-order-invoice").onclick = () => downloadInvoice(order);
            openModal("#order-details-modal");
        };

        const openOrderEditModal = order => {
            editingOrderId = order.orderId;
            $("#edit-name").value = order.name || "";
            $("#edit-dob").value = order.dob || "";
            $("#edit-phone").value = order.phone || "";
            openModal("#order-edit-modal");
        };

        const saveEditedOrder = async e => {
            e.preventDefault();
            if (!editingOrderId) return;
            const upd = {
                name: $("#edit-name").value.trim(),
                dob: $("#edit-dob").value.trim(),
                phone:$("#edit-phone").value.trim()
            };
            if (!upd.name || !upd.dob || !upd.phone) {
                toast("All fields are required.", "danger");
                return;
            }
            const phoneRegex = /^\d{10,15}$/;
            if (!phoneRegex.test(upd.phone)) {
                toast("Phone number must be 10-15 digits.", "danger");
                return;
            }
            showLoading("Saving changes…");
            try {
                const uid = currentUser.uid;
                await update(ref(db, `orders/${uid}/${editingOrderId}`), upd);
                await update(ref(db, `globalOrders/${editingOrderId}`), upd);
                await update(ref(db, `orderDetails/${editingOrderId}`), upd);
                toast("Order details updated.");
                closeModal("#order-edit-modal");
                editingOrderId = null;
            } catch (e) {
                console.error("Failed to update order:", e);
                toast("Failed to update order.", "danger");
            } finally {
                hideLoading();
            }
        };

        const renderProfile = () => {
            if (!currentUser) return;
            const uid = currentUser.uid;
            get(ref(db, `users/${uid}/profile`)).then(snap=>{
                const d = snap.val()||{};
                userProfile = d;
                $("#profile-info").innerHTML = `
                    <p><strong>Name:</strong> ${d.name||'N/A'}</p>
                    <p><strong>Date of Birth:</strong> ${d.dob||'N/A'}</p>
                    <p><strong>Place of Birth (POB):</strong> ${d.pob||'N/A'}</p>
                    <p><strong>Time of Birth (TOB):</strong> ${d.tob||'N/A'}</p>
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>Phone:</strong> ${d.phone||'N/A'}</p>
                `;
            }).catch(e => {
                console.error("Error fetching profile:", e);
                toast("Failed to load profile data.", "danger");
            });
        };

        const openProfileEdit = () => {
            const uid = currentUser.uid;
            get(ref(db, `users/${uid}/profile`)).then(snap=>{
                const d = snap.val()||{};
                $("#profile-edit-name").value = d.name||"";
                $("#profile-edit-dob").value = d.dob||"";
                $("#profile-edit-pob").value = d.pob||"";
                $("#profile-edit-tob").value = d.tob||"";
                $("#profile-edit-phone").value = d.phone||"";
                openModal("#profile-edit-modal");
            }).catch(e => {
                console.error("Error fetching profile for edit:", e);
                toast("Failed to load profile data for editing.", "danger");
            });
        };

        const saveProfileEdit = async e => {
            e.preventDefault();
            const uid = currentUser.uid;
            const upd = {
                name: $("#profile-edit-name").value.trim(),
                dob: $("#profile-edit-dob").value.trim(),
                phone:$("#profile-edit-phone").value.trim(),
                pob: $("#profile-edit-pob").value.trim(), 
                tob: $("#profile-edit-tob").value.trim() 
            };
            if (!upd.pob) delete upd.pob;
            if (!upd.tob) delete upd.tob;
            if (!upd.name || !upd.dob || !upd.phone) {
                toast("Name, DOB, and Phone are required.", "danger");
                return;
            }
            const phoneRegex = /^\d{10,15}$/;
            if (!phoneRegex.test(upd.phone)) {
                toast("Phone number must be 10-15 digits.", "danger");
                return;
            }
            showLoading("Updating profile...");
            try {
                await set(ref(db, `users/${uid}/profile`), upd);
                userProfile = upd;
                toast("Profile updated.");
                closeModal("#profile-edit-modal");
                renderProfile();
            } catch (error) {
                console.error("Error updating profile:", error);
                toast("Failed to update profile.", "danger");
            } finally {
                hideLoading();
            }
        };

        const loadProducts = async () => {
            try {
                const snap = await get(ref(db, "products"));
                if (snap.exists()) {
                    const data = snap.val();
                    products = Object.entries(data).map(([id,p])=>({
                        id,
                        name:p.name,
                        price:Number(p.price),
                        imageUrl:p.imageUrl,
                        description:p.description,
                        category:p.category
                    }));
                    const catSet = new Set(products.map(p=>p.category));
                    categories = Array.from(catSet);
                    renderCategories();
                    renderProducts();
                } else {
                    toast("No products found.", "info");
                }
            } catch (error) {
                console.error("Error loading products:", error);
                toast("Failed to load products.", "danger");
            }
        };

        const loadSlider = async () => {
            const sliderImageWrapper = $("#slider-image-wrapper");
            const img = $("#slider-img");

            // Add skeleton class initially
            sliderImageWrapper.classList.add("skeleton");
            img.classList.remove("loaded"); // Ensure image is hidden

            try {
                const snap = await get(ref(db, "sliderImages"));
                if (snap.exists()) {
                    const imgs = Object.values(snap.val()).map(i=>i.downloadURL);
                    let idx = 0;
                    const show = () => {
                        img.src = imgs[idx];
                        img.onload = () => {
                            sliderImageWrapper.classList.remove("skeleton"); // Remove skeleton when image is loaded
                            img.classList.add("loaded"); // Show image
                        };
                        img.onerror = () => { // Handle image loading errors
                            sliderImageWrapper.classList.remove("skeleton");
                            img.classList.remove("loaded");
                            img.src = "https://via.placeholder.com/800x300?text=Error Loading Image";
                            img.alt = "Error Loading Image";
                            img.classList.add("loaded"); // Show error image
                        };
                    };
                    show();
                    $("#slider-prev").onclick = () => {
                        idx = (idx-1+imgs.length)%imgs.length;
                        show();
                    };
                    $("#slider-next").onclick = () => {
                        idx = (idx+1)%imgs.length;
                        show();
                    };
                    setInterval(() => {
                        idx = (idx+1)%imgs.length;
                        show();
                    }, 5000);
                } else {
                    // Fallback if no images in DB
                    img.src = "https://via.placeholder.com/800x300?text=No Slider Images";
                    img.onload = () => {
                        sliderImageWrapper.classList.remove("skeleton");
                        img.classList.add("loaded");
                    };
                }
            } catch (error) {
                console.error("Error loading slider images:", error);
                toast("Failed to load slider images.", "danger");
                // Fallback even on error
                img.src = "https://via.placeholder.com/800x300?text=Error Loading Slider";
                img.onload = () => {
                    sliderImageWrapper.classList.remove("skeleton");
                    img.classList.add("loaded");
                };
            }
        };

        const authListener = () => {
            onAuthStateChanged(auth, async user => {
                const previousUser = currentUser;
                currentUser = user;
                if (user) {
                    $("#login-status-indicator").style.display = "inline-block";
                    const uid = user.uid;
                    const profileSnap = await get(ref(db, `users/${uid}/profile`));
                    userProfile = profileSnap.val() || {};
                    onValue(ref(db, `users/${uid}/cart`), snap => {
                        cart = snap.val() || {};
                        renderCart();
                        updateBadges();
                    }, { onlyOnce: false });
                    onValue(ref(db, `users/${uid}/wishlist`), snap => {
                        wishlist = snap.val() || {};
                        renderWishlist();
                        updateBadges();
                        document.querySelectorAll(".wishlist").forEach(icon => {
                            const pid = icon.dataset.id;
                            icon.textContent = wishlist[pid] ? "❤️" : "🖤";
                        });
                    }, { onlyOnce: false });
                    onValue(ref(db, `orders/${uid}`), snap => {
                        renderOrders(snap);
                    }, { onlyOnce: false });
                    if (!previousUser) {
                       await mergeLocalData();
                    }
                    $("#menu-login-logout a").textContent = "Logout";
                    $("#menu-login-logout a").onclick = e=>{
                        e.preventDefault();
                        logout();
                    };
                } else {
                    $("#login-status-indicator").style.display = "none";
                    cart = JSON.parse(localStorage.getItem("guest_cart")||"{}");
                    wishlist = JSON.parse(localStorage.getItem("guest_wishlist")||"{}");
                    userProfile = {};
                    renderCart();
                    renderWishlist();
                    updateBadges();
                    document.querySelectorAll(".wishlist").forEach(icon => {
                        const pid = icon.dataset.id;
                        icon.textContent = wishlist[pid] ? "❤️" : "🖤";
                    });
                    $("#menu-login-logout a").textContent = "Login";
                    $("#menu-login-logout a").onclick = e=>{
                        e.preventDefault();
                        openModal("#login-modal");
                        navigateTo('/login'); // Update URL to reflect modal state
                    };
                }
                router();
            });
        };

        const mergeLocalData = async () => {
            if (!currentUser) return;
            const uid = currentUser.uid;
            const localCart = JSON.parse(localStorage.getItem("guest_cart")||"{}");
            let cartMerged = false;
            for (const pid in localCart) {
                const it = localCart[pid];
                try {
                    await runTransaction(ref(db, `users/${uid}/cart/${pid}`), cur=>{
                        if (cur===null) return {
                            quantity:it.quantity,
                            name:it.name,
                            price:it.price,
                            image:it.image
                        };
                        cur.quantity += it.quantity;
                        return cur;
                    });
                    cartMerged = true;
                } catch (e) {
                    console.error(`Error merging cart item ${pid}:`, e);
                }
            }

            const localWish = JSON.parse(localStorage.getItem("guest_wishlist")||"{}");
            let wishMerged = false;
            for (const pid in localWish) {
                const it = localWish[pid];
                try {
                    await set(ref(db, `users/${uid}/wishlist/${pid}`), {
                        name:it.name,
                        price:it.price,
                        image:it.image
                    });
                    wishMerged = true;
                } catch (e) {
                    console.error(`Error merging wishlist item ${pid}:`, e);
                }
            }

            if (cartMerged || wishMerged) {
                localStorage.removeItem("guest_cart");
                localStorage.removeItem("guest_wishlist");
                toast("Guest cart & wishlist merged with your account.", "info");
            }
        };

        const login = async (email, pass) => {
            showLoading("Logging in...");
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                closeModal("#login-modal");
                toast("Logged in successfully!");
            } catch (e) {
                toast("Login failed: " + e.message, "danger");
            } finally {
                hideLoading();
            }
        };

        const register = async (name, dob, pob, tob, email, phone, pass) => {
            showLoading("Registering...");
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const uid = cred.user.uid;
                
                const profileData = {name, dob, phone};
                if (pob) profileData.pob = pob;
                if (tob) profileData.tob = tob;
                
                await set(ref(db, `users/${uid}/profile`), profileData);
                closeModal("#register-modal");
                toast("Registration successful! You are now logged in.");
            } catch (e) {
                toast("Registration failed: " + e.message, "danger");
                throw e;
            } finally {
                hideLoading();
            }
        };

        const logout = async () => {
            try {
                showLoading("Logging out...");
                await signOut(auth);
                navigateTo("/home");
                toast("Logged out successfully.");
            } catch (e) {
                console.error("Logout error:", e);
                toast("Failed to logout.", "danger");
            } finally {
                hideLoading();
            }
        };

        const checkout = () => {
            if (!currentUser) {
                toast("Please login to proceed to checkout.", "info");
                openModal("#login-modal");
                navigateTo("/login"); // Update URL to reflect modal state
                return;
            }
            if (Object.keys(cart).length === 0) {
                toast("Your cart is empty. Please add items before checking out.", "danger");
                return;
            }
            const uid = currentUser.uid;
            get(ref(db, `users/${uid}/profile`)).then(snap=>{
                const d = snap.val()||{};
                $("#ship-name").value = d.name||"";
                $("#ship-dob").value = d.dob||"";
                $("#ship-email").value = currentUser.email||"";
                $("#ship-phone").value = d.phone||"";
            }).catch(e => {
                console.error("Error fetching user profile for checkout:", e);
                toast("Failed to load profile for checkout. Please update your profile.", "danger");
            });
            openModal("#checkout-modal");
            navigateTo("/checkout-details"); // Update URL to reflect modal state
        };
        
        const prepareOrderDetailsForPayment = (existingOrder = null, paymentMethodChosen = null) => {
            let orderItems;
            let currentTotals;
            let couponToApply = appliedCoupon;

            if (existingOrder && existingOrder.selectedServices) {
                orderItems = existingOrder.selectedServices.map(s => ({
                    productId: s.productId,
                    name: s.serviceName,
                    price: s.price,
                    quantity: s.quantity
                }));
                currentTotals = {
                    subtotal: orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    discount: existingOrder.discountAmount || 0,
                    totalBeforeFees: existingOrder.totalAmount - (existingOrder.transactionFeesAmount || 0) 
                };
                if (existingOrder.couponCode) {
                    if (!appliedCoupon || appliedCoupon.code !== existingOrder.couponCode) {
                        couponToApply = { code: existingOrder.couponCode, type: 'fixed', value: existingOrder.discountAmount, minOrder: 0 }; 
                    }
                } else {
                    couponToApply = null;
                }
            } else {
                orderItems = Object.entries(cart).map(([pid,it])=>({
                    productId: pid,
                    name: it.name,
                    price: it.price,
                    quantity: it.quantity
                }));
                const calculated = calculateCartTotal();
                currentTotals = {
                    subtotal: calculated.subtotal,
                    discount: calculated.discount,
                    totalBeforeFees: calculated.total
                };
            }
            let finalTotalAmount = currentTotals.totalBeforeFees;
            let transactionFees = 0;
            if (paymentMethodChosen === "Pay Now") {
                transactionFees = TRANSACTION_FEES_FLAT_AMOUNT;
                finalTotalAmount += transactionFees;
            }
            return {
                orderId: existingOrder?.orderId || null,
                items: orderItems,
                totalAmount: Math.max(0, finalTotalAmount),
                discountAmount: currentTotals.discount,
                couponCode: couponToApply ? couponToApply.code : "",
                transactionFeesAmount: transactionFees,
                shipping: {
                    name: $("#ship-name").value,
                    dob: $("#ship-dob").value,
                    email: $("#ship-email").value,
                    phone: $("#ship-phone").value
                }
            };
        }

        const startRazorpay = async () => {
            closeModal("#payment-method-modal");
            navigateTo("/payment-method-selection"); // Keep URL updated, even if modal closed.
            closeModal("#checkout-modal");
            navigateTo("/checkout-details"); // Keep URL updated, even if modal closed.

            let currentOrderDetails = null;
            if (pendingOrderId && pendingOrderData) {
                currentOrderDetails = prepareOrderDetailsForPayment(pendingOrderData, "Pay Now"); 
            } else {
                if (!validateShippingDetails()) { 
                    hideLoading();
                    return;
                }
                currentOrderDetails = prepareOrderDetailsForPayment(null, "Pay Now"); 
            }
            const amountPaise = Math.round(currentOrderDetails.totalAmount * 100); 

            if (currentOrderDetails.totalAmount <= 0) { 
                 showLoading("Processing order...");
                 try {
                     const orderObj = {
                         ...currentOrderDetails,
                         status: "Completed",
                         paymentMethod: "Zero Amount Order",
                         transactionId: "N/A",
                         transactionFeesAmount: 0,
                         adminOrderStatus: "In Progress"
                     };
                     const savedOrder = await createOrderRecord(orderObj);
                     if (savedOrder.couponCode) await incrementCouponUsage(savedOrder.couponCode);
                     await clearCartAfterOrder();
                     downloadInvoice(savedOrder);
                     await sendConfirmationEmail(savedOrder);
                     sendWhatsAppOrderConfirmation(savedOrder);
                     $("#success-name").textContent = savedOrder.name;
                     $("#success-dob").textContent = savedOrder.dob;
                     $("#success-email").textContent = savedOrder.email;
                     $("#success-phone").textContent = savedOrder.phone;
                     const { paymentStatus: successPaymentStatus, orderStatus: successOrderStatus } = deriveStatuses(savedOrder);
                     $("#success-status").innerHTML = `Your Payment Status Is <strong class="status-badge status-deep-green">${successPaymentStatus}</strong> And Your Order Status Is <strong class="status-badge status-light-green">${successOrderStatus}</strong>`;
                     navigateTo("/success");
                     toast("Order placed successfully!", "success");
                 } catch (e) {
                     console.error("Error with zero amount order:", e);
                     toast("Failed to process zero amount order.", "danger");
                     navigateTo("/failure");
                 } finally {
                     hideLoading();
                     resetOrderState();
                 }
                 return;
            }

            const options = {
                key: RAZORPAY_KEY,
                amount: amountPaise,
                currency: "INR",
                name: "Astroshrae",
                description: `Payment for Order ${currentOrderDetails.orderId || 'New'}`,
                image: "https://iili.io/K5eHgUb.png",
                order_id: "",
                prefill: {
                    name: currentOrderDetails.shipping.name,
                    email: currentOrderDetails.shipping.email,
                    contact: currentOrderDetails.shipping.phone
                },
                notes: {
                    dob: currentOrderDetails.shipping.dob,
                    orderId: currentOrderDetails.orderId || "New Order",
                    transactionFees: currentOrderDetails.transactionFeesAmount
                },
                theme: {
                    color: "#7266ba"
                },
                handler: async resp => {
                    showLoading("Processing payment…");
                    try {
                        const orderObj = {
                            ...currentOrderDetails,
                            status: "Completed",
                            paymentMethod: "Pay Now",
                            transactionId: resp.razorpay_payment_id,
                            adminOrderStatus: "Pending"
                        };
                        const savedOrder = await createOrderRecord(orderObj);
                        if (savedOrder.couponCode) await incrementCouponUsage(savedOrder.couponCode);
                        await clearCartAfterOrder();
                        downloadInvoice(savedOrder);
                        await sendConfirmationEmail(savedOrder);
                        sendWhatsAppOrderConfirmation(savedOrder);
                        $("#success-name").textContent = savedOrder.name;
                        $("#success-dob").textContent = savedOrder.dob;
                        $("#success-email").textContent = savedOrder.email;
                        $("#success-phone").textContent = savedOrder.phone;
                        const { paymentStatus: successPaymentStatus, orderStatus: successOrderStatus } = deriveStatuses(savedOrder);
                        $("#success-status").innerHTML = `Your Payment Status Is <strong class="status-badge status-deep-green">${successPaymentStatus}</strong> And Your Order Status Is <strong class="status-badge status-light-green">${successOrderStatus}</strong>`;
                        navigateTo("/success");
                        toast("Thank you for your order! Payment was successful.", "success");
                    } catch (e) {
                        console.error("Error during Razorpay success handling:", e);
                        $("#failure-msg").textContent = "Payment verification failed. Your order status is 'Pending'. Please try again or choose 'Pay Later'.";
                        navigateTo("/failure");
                        toast("Payment verification failed. Please check your orders.", "danger");
                    } finally {
                        hideLoading();
                        resetOrderState();
                    }
                },
                modal: {
                    ondismiss: async () => {
                        hideLoading();
                        // If it's a retry/conversion from Pay Later, update existing order
                        if (pendingOrderId && pendingOrderData) {
                            await update(ref(db, `orders/${currentUser.uid}/${pendingOrderId}`), { 
                                status: "Pending", 
                                paymentMethod: "Payment Failed/Cancelled",
                                transactionFeesAmount: 0 // Reset fees if failed
                            });
                            await update(ref(db, `globalOrders/${pendingOrderId}`), { 
                                status: "Pending", 
                                paymentMethod: "Payment Failed/Cancelled",
                                transactionFeesAmount: 0
                            });
                            await update(ref(db, `orderDetails/${pendingOrderId}`), { 
                                status: "Pending", 
                                paymentMethod: "Payment Failed/Cancelled",
                                transactionFeesAmount: 0
                            });
                            $("#failure-msg").textContent = `Payment was cancelled for order ${pendingOrderId}. It is now in 'Pending' status. You can retry payment from 'My Orders' or switch to 'Pay Later'.`;
                            navigateTo("/failure");
                            toast("Payment cancelled. You can retry from 'My Orders' or switch to 'Pay Later'.", "info");
                        } else {
                            // If it was a new checkout, create a new order as Pending
                            const orderObj = {
                                ...currentOrderDetails,
                                status: "Pending",
                                paymentMethod: "Payment Failed/Cancelled",
                                transactionFeesAmount: 0
                            };
                            const savedOrder = await createOrderRecord(orderObj); 
                            // Only clear cart if it was a new checkout, not a retry of existing
                            // await clearCartAfterOrder(); // Don't clear cart here, user might retry same cart
                            downloadInvoice(savedOrder);
                            await sendConfirmationEmail(savedOrder);
                            sendWhatsAppOrderConfirmation(savedOrder);
                            $("#failure-msg").textContent = `Payment was cancelled. Your order ${savedOrder.orderId} has been placed with status 'Pending'. You can retry payment from 'My Orders' or switch to 'Pay Later'.`;
                            navigateTo("/failure");
                            toast("Payment cancelled. You can retry from 'My Orders' or switch to 'Pay Later'.", "info");
                        }
                        resetOrderState();
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        };

        const initiatePayLater = async (existingOrderToConvert = null) => {
            closeModal("#payment-method-modal");
            navigateTo("/payment-method-selection"); // Keep URL updated, even if modal closed.
            closeModal("#checkout-modal");
            navigateTo("/checkout-details"); // Keep URL updated, even if modal closed.

            if (!existingOrderToConvert && !validateShippingDetails()) {
                hideLoading();
                return;
            }
            showLoading("Placing your order…");
            try {
                const currentOrderDetails = prepareOrderDetailsForPayment(existingOrderToConvert, "Pay Later"); 
                const orderId = currentOrderDetails.orderId || await generateOrderId(); 
                const orderObj = {
                    ...currentOrderDetails,
                    orderId: orderId,
                    status: "Pending Verification",
                    paymentMethod: "Pay Later",
                    transactionFeesAmount: 0,
                    adminOrderStatus: "Pending"
                };
                const savedOrder = await createOrderRecord(orderObj);
                if (savedOrder.couponCode) await incrementCouponUsage(savedOrder.couponCode);
                if (!existingOrderToConvert) {
                    await clearCartAfterOrder();
                }
                downloadInvoice(savedOrder);
                await sendConfirmationEmail(savedOrder);
                sendWhatsAppOrderConfirmation(savedOrder);
                hideLoading();
                $("#pay-later-order-id-display").textContent = savedOrder.orderId;
                navigateTo("/pay-later-confirm-page");
                toast(`Order ${savedOrder.orderId} placed successfully! Status: Pending Verification. Invoice downloaded.`, "success");
            } catch (e) {
                console.error("Error initiating Pay Later order:", e);
                hideLoading();
                toast("Failed to place Pay Later order. Please try again.", "danger");
                navigateTo("/home");
            } finally {
                resetOrderState();
            }
        };

        const resetOrderState = () => {
            pendingOrderId = null;
            pendingOrderData = null;
            appliedCoupon = null;
            $("#coupon-code").value = "";
            $("#coupon-message").textContent = "";
            $("#coupon-message").className = "coupon-message";
        };

        const clearCartAfterOrder = async () => {
            if (currentUser) {
                await remove(ref(db, `users/${currentUser.uid}/cart`));
            }
            cart = {};
            renderCart();
            updateBadges();
        };

        const cancelPendingOrder = async () => {
            if (!currentUser) {
                toast("Please login to cancel orders.", "info");
                openModal("#login-modal");
                navigateTo("/login"); // Update URL to reflect modal state
                return;
            }
            if (pendingOrderId) {
                showLoading("Cancelling order...");
                try {
                    const uid = currentUser.uid;
                    // Update status to 'Cancelled' instead of removing entirely
                    await update(ref(db, `orders/${uid}/${pendingOrderId}`), { status: "Cancelled", adminOrderStatus: "Cancelled" });
                    await update(ref(db, `globalOrders/${pendingOrderId}`), { status: "Cancelled", adminOrderStatus: "Cancelled" });
                    await update(ref(db, `orderDetails/${pendingOrderId}`), { status: "Cancelled", adminOrderStatus: "Cancelled" });
                    toast(`Order ${pendingOrderId} cancelled.`);
                    navigateTo("/order");
                } catch (e) {
                    console.error("Error cancelling order:", e);
                    toast("Failed to cancel order.", "danger");
                } finally {
                    hideLoading();
                    resetOrderState();
                }
            } else {
                toast("No pending order to cancel.", "info");
                navigateTo("/order");
            }
        };

        const applyCoupon = async () => {
            const code = $("#coupon-code").value.trim().toUpperCase();
            if (!code) {
                $("#coupon-message").textContent = "Please enter a coupon code.";
                $("#coupon-message").className = "coupon-message coupon-error";
                appliedCoupon = null;
                renderCart();
                return;
            }
            showLoading("Checking coupon...");
            try {
                const couponRef = ref(db, `coupons/${code}`);
                const snapshot = await get(couponRef);
                if (snapshot.exists()) {
                    const couponData = snapshot.val();
                    const now = Date.now();
                    const cartTotals = calculateCartTotal();

                    if (Object.keys(cart).length === 0) {
                        $("#coupon-message").textContent = "Cannot apply coupon to an empty cart.";
                        $("#coupon-message").className = "coupon-message coupon-error";
                        appliedCoupon = null;
                    } else if (!couponData.active) {
                        $("#coupon-message").textContent = "This coupon is not active.";
                        $("#coupon-message").className = "coupon-message coupon-error";
                        appliedCoupon = null;
                    } else if (couponData.validUntil && now > couponData.validUntil) {
                        $("#coupon-message").textContent = "This coupon has expired.";
                        $("#coupon-message").className = "coupon-message coupon-error";
                        appliedCoupon = null;
                    } else if (couponData.usageLimit && (couponData.usageCount || 0) >= couponData.usageLimit) {
                        $("#coupon-message").textContent = "This coupon has reached its usage limit.";
                        $("#coupon-message").className = "coupon-message coupon-error";
                        appliedCoupon = null;
                    } else if (couponData.minOrder && cartTotals.subtotal < couponData.minOrder) {
                        $("#coupon-message").textContent = `Coupon "${code}" is only valid for orders of ${fmt(couponData.minOrder)} or more.`;
                        $("#coupon-message").className = "coupon-message coupon-error";
                        appliedCoupon = null;
                    }
                    else {
                        appliedCoupon = {
                            code: code,
                            type: couponData.discountType, 
                            value: couponData.discountValue, 
                            usageCount: couponData.usageCount || 0,
                            minOrder: couponData.minOrder || 0
                        };
                        $("#coupon-message").textContent = 
                            `Coupon "${code}" applied: ${couponData.discountType === 'percentage' ? 
                                couponData.discountValue + '%' : fmt(couponData.discountValue)} discount.`;
                        $("#coupon-message").className = "coupon-message coupon-success";
                    }
                } else {
                    $("#coupon-message").textContent = "Invalid coupon code.";
                    $("#coupon-message").className = "coupon-message coupon-error";
                    appliedCoupon = null;
                }
            } catch (error) {
                console.error("Error applying coupon:", error);
                $("#coupon-message").textContent = "Error applying coupon. Please try again later.";
                $("#coupon-message").className = "coupon-message coupon-error";
                appliedCoupon = null;
            } finally {
                hideLoading();
                renderCart();
            }
        };

        const incrementCouponUsage = async (couponCode) => {
            if (!couponCode) return;
            const couponRef = ref(db, `coupons/${couponCode}`);
            try {
                await runTransaction(couponRef, (currentCoupon) => {
                    if (currentCoupon) {
                        currentCoupon.usageCount = (currentCoupon.usageCount || 0) + 1;
                    }
                    return currentCoupon;
                });
            } catch (error) {
                console.error("Error incrementing coupon usage:", error);
            }
        };

        const downloadInvoice = order => {
            const { paymentStatus, orderStatus } = deriveStatuses(order);
            const itemsRows = order.selectedServices.map(s => `
                <tr class="item">
                    <td>${s.serviceName} (x${s.quantity})</td>
                    <td>${fmt(s.price * s.quantity)}</td>
                </tr>
            `).join('');
            const qrCodeInInvoice = order.paymentMethod.startsWith("Pay Later") ? `
                <tr class="item">
                    <td><strong>Payment QR Code (for offline payment)</strong></td>
                    <td><img src="https://i.ibb.co/gFP2VQcf/cachesm-qr-1755144422734.jpg" style="width:100px; height:100px; display:block; margin: 0 auto; border: 1px solid #eee; padding: 5px; border-radius: 8px;" alt="QR Code" loading="eager"></td>
                </tr>
                <tr class="item last">
                    <td colspan="2" style="font-size: 0.8em; text-align: center; color: #777;">Please scan to complete your payment. Your order status will be updated after manual verification.</td>
                </tr>
            ` : '';
            const discountRow = order.discountAmount > 0 ? `
                <tr class="item">
                    <td>Discount (Coupon: ${order.couponCode || 'N/A'})</td>
                    <td>-${fmt(order.discountAmount)}</td>
                </tr>
            ` : '';
            const transactionFeesRow = order.transactionFeesAmount > 0 ? `
                 <tr class="item">
                    <td>Transaction Fees</td>
                    <td>${fmt(order.transactionFeesAmount)}</td>
                </tr>
            ` : '';
            const html = `
                <html>
                <head>
                    <title>Invoice ${order.orderId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
                        .invoice-box { max-width: 800px; margin: 50px auto; padding: 30px; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0, 0, 0, .15); font-size: 14px; line-height: 24px; color: #555; background-color: #fff; border-radius: 8px; }
                        .invoice-box table { width: 100%; line-height: inherit; text-align: left; border-collapse: collapse; }
                        .invoice-box table td { padding: 8px; vertical-align: top; }
                        .invoice-box table tr td:nth-child(2) { text-align: right; }
                        .invoice-box table tr.top table td { padding-bottom: 20px; }
                        .invoice-box table tr.top table td.title { font-size: 40px; line-height: 40px; color: #333; }
                        .invoice-box table tr.information table td { padding-bottom: 30px; }
                        .invoice-box table tr.heading td { background: #eee; border-bottom: 1px solid #ddd; font-weight: bold; }
                        .invoice-box table tr.details td { padding-bottom: 15px; }
                        .invoice-box table tr.item td { border-bottom: 1px solid #eee; }
                        .invoice-box table tr.item.last td { border-bottom: none; }
                        .invoice-box table tr.total td:nth-child(2) { border-top: 2px solid #eee; font-weight: bold; font-size: 1.1em; }
                        .footer { margin-top: 30px; text-align: center; color: #777; font-size: 0.9em; }
                        .logo-img { width: 100%; max-width: 150px; display: block; margin-bottom: 10px; }
                    </style>
                </head>
                <body>
                    <div class="invoice-box">
                        <table cellpadding="0" cellspacing="0">
                            <tr class="top">
                                <td colspan="2">
                                    <table>
                                        <tr>
                                            <td class="title"><img src="https://iili.io/K5eHgUb.png" class="logo-img" alt="Astroshrae Logo" loading="eager"></td>
                                            <td><strong>Invoice #:</strong> ${order.orderId}<br><strong>Date:</strong> ${new Date(order.timestamp).toLocaleDateString('en-IN')}<br><strong>Payment Status:</strong> ${paymentStatus}<br><strong>Order Status:</strong> ${orderStatus}<br></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr class="information">
                                <td colspan="2">
                                    <table>
                                        <tr>
                                            <td><strong>Astroshrae</strong><br>Website: ${window.location.origin}/home<br>Email: astroshrae1@gmail.com<br>Phone: +91 9436906667</td>
                                            <td><strong>Customer:</strong><br>${order.name}<br>${order.email}<br>${order.phone}<br>DOB: ${order.dob}</td>
                                        </tr>
                                    </table>
                            </td>
                        </tr>
                        <tr class="heading"><td>Service Description</td><td>Amount</td></tr>
                        ${itemsRows}
                        ${discountRow}
                        ${transactionFeesRow}
                        ${qrCodeInInvoice}
                        <tr class="total"><td></td><td>Total: ${fmt(order.totalAmount)}</td></tr>
                    </table>
                    <div class="footer"><p>Thank you for choosing Astroshrae!</p><p>Unlock cosmic guidance with trusted numerology services.</p></div>
                </div>
            </body>
            </html>
        `;
        const blob = new Blob([html],{type:"text/html"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Invoice_Astroshrae_${order.orderId}.html`;
        a.click();
        URL.revokeObjectURL(url);
        toast("Invoice downloaded successfully!", "success");
    };

        const exportOrderData = order => {
            const dataStr = JSON.stringify(order, null, 2);
            const blob = new Blob([dataStr], {type:"application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Order_Astroshrae_${order.orderId}.json`;
            a.click();
            URL.revokeObjectURL(url);
            toast("Order data downloaded successfully!", "success");
        };

        const faqsData = [
            { question: "How To Order In My Website", answer: "First Add A Service In The Cart By Clicking Add To Cart And Then Go To Cart And Then If You Have Coupon Then Apply If Not Then Leave It And Click Proceed To Checkout And After That See Your Details As Name, Phone Number, DOB, Gmail Etc Then Click Select Payment Methods As Pay Now For Paying Now For Payment Later You Should To Pay Directly In WhatsApp Astroshrae Will Ask For Payment Then You Can See Your Order Is Placed You Should Send A Confirmation Messages To Astroshrae To Confirm The Request Fastly." },
            { question: "What Is Astroshrae?", answer: "Astroshrae Is A Professional Numerology And Life Guidance Platform Providing Personalized Services And Remedies To Improve Career, Health, Relationships, And Spiritual Growth. Astroshrae Is A Trusted Platform That Provides Personalized Numerology Reports, Compatibility Analysis, Remedies, And Consultations For Individuals And Businesses Worldwide." },
            { question: "What Is Numerology", answer: "Numerology Is The Study Of Numbers And Their Vibrational Influence On Life, Personality, Destiny, And Success."},
            { question: "What Can Numerology Do", answer: "Numerology Can Help In Self Discovery, Career Guidance, Relationship Compatibility, Lucky Name And Number Suggestions, Auspicious Dates, And Remedies To Balance Life Energy." },
            { question: "What Can Numerology Not Do", answer: "Numerology Cannot Replace Medical, Legal, Or Financial Advice And Does Not Guarantee Immediate Results." },
            { question: "Who Can Use Astroshrae Services", answer: "Anyone Interested In Understanding Their Life Path, Improving Decisions, Or Seeking Remedies Can Use Astroshrae Services." },
            { question: "How Accurate Are Astroshrae Numerology Reports", answer: "Astroshrae Reports Are Accurate Because They Are Based On Proven Numerology Methods And Personalized Analysis." },
            { question: "How To Contact Astroshrae", answer: "You Can Contact Astroshrae Via WhatsApp, Email At Astroshrae1@Gmail.Com Or Phone Number +919436906667 For Any Query Or Support." },
            { question: "Is Astroshrae Available Worldwide", answer: "Yes, Astroshrae Provides Services To Clients Across India And Other Countries Through Online Consultations And Reports." },
            { question: "Payment Methods Supported By Astroshrae", answer: "Astroshrae Supports UPI, Google Pay, PhonePe, Paytm, Debit And Credit Cards, And Online Payments. Cash Is Not Supported." },
            { question: "What Should I Do After Placing An Order", answer: "After Placing An Order, Send A Confirmation Message To Astroshrae On WhatsApp To Verify And Process Your Request Quickly." },
            { question: "Can I Pay Later For My Astroshrae Order", answer: "Yes, You Can Pay Later By Contacting Astroshrae On WhatsApp And They Will Provide Instructions To Complete The Payment." },
            { question: "Can I Book Astroshrae Services Online", answer: "Yes, Astroshrae Offers Complete Online Services Including Reports, Consultations, And Guidance Accessible Worldwide." },
            { question: "How Do I Apply A Coupon On Astroshrae Website", answer: "After Adding The Service To Cart, Enter Your Coupon Code In The Coupon Section And Click Apply Before Proceeding To Checkout." },
            { question: "How Do I Get Name Correction Service", answer: "Select Name Correction Service Priced At ₹2100, Add To Cart, Complete Checkout, Provide Name Details, And Send Confirmation Message To Astroshrae." },
            { question: "What Is Name Correction Service", answer: "Name Correction Service Helps Align Your Name With Numerology Principles To Improve Career, Relationships, Luck, And Overall Harmony." },
            { question: "How Do I Get Marriage Compatibility Service", answer: "Select Marriage Compatibility Service Priced At ₹499, Add To Cart, Enter Details Of Both Partners, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Marriage Compatibility Service", answer: "This Service Analyzes The Names And Dates Of Birth Of Partners To Evaluate Relationship Harmony And Compatibility." },
            { question: "How Do I Get Vedic Remedies", answer: "Select Vedic Remedies Service Priced At ₹299, Add To Cart, Provide Birth Details, Complete Checkout, And Send Confirmation Message." },
            { question: "What Are Vedic Remedies", answer: "Vedic Remedies Include Gemstones, Colors, Numbers, And Spiritual Practices Personalized To Balance Life Energy And Improve Luck." },
            { question: "How Do I Get Mobilogy Service", answer: "Select Mobilogy Service Priced At ₹499, Add To Cart, Provide Mobile Number, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Mobilogy", answer: "Mobilogy Is Mobile Number Analysis That Suggests Lucky Numbers And Combinations For Career, Relationships, And Personal Growth." },
            { question: "How Do I Get Signature Analysis", answer: "Select Signature Analysis Service Priced At ₹299, Add To Cart, Provide Signature Image Or Details, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Signature Analysis", answer: "Signature Analysis Helps Suggest Modifications To Improve Personal And Professional Outcomes." },
            { question: "How Do I Get House Number Analysis", answer: "Select House Number Analysis Priced At ₹299, Add To Cart, Enter House Number, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is House Number Analysis", answer: "House Number Analysis Helps Determine If Your House Number Brings Prosperity, Happiness, And Positive Energy." },
            { question: "How Do I Get Vehicle Number Analysis", answer: "Select Vehicle Number Analysis Priced At ₹299, Add To Cart, Provide Vehicle Number, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Vehicle Number Analysis", answer: "Vehicle Number Analysis Ensures That Your Vehicle Number Brings Luck, Safety, And Success In Journeys." },
            { question: "How Do I Get Missing Number Remedies", answer: "Select Missing Number Remedies Service Priced At ₹299, Add To Cart, Provide Name And Birth Details, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Are Missing Number Remedies", answer: "Missing Number Remedies Identify Missing Or Weak Numbers In Your Name Or Birth Date And Provide Remedies To Balance Life Energy." },
            { question: "How Do I Get Numero Vastu", answer: "Select Numero Vastu Service Priced At ₹499, Add To Cart, Enter House Or Office Details, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Numero Vastu", answer: "Numero Vastu Combines Numerology And Vastu Principles To Harmonize Home Or Office Spaces For Prosperity And Health." },
            { question: "How Do I Get Feng Shui Remedies", answer: "Select Feng Shui Remedies Service Priced At ₹299, Add To Cart, Provide Details, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Are Feng Shui Remedies", answer: "Feng Shui Remedies Suggest Adjustments To Home Or Work Spaces Based On Your Numbers To Promote Positive Energy And Success." },
            { question: "How Do I Get Trigram Therapy", answer: "Select Trigram Therapy Priced At ₹159, Add To Cart, Provide Necessary Details, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Trigram Therapy", answer: "Trigram Therapy Aligns Your Life With Natural Energy Patterns To Improve Health, Wealth, And Harmony." },
            { question: "How Do I Get Lo Shu Grid & Pa Kua Method", answer: "Select Lo Shu Grid & Pa Kua Method Priced At ₹499, Add To Cart, Provide Date Of Birth And Name Details, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Lo Shu Grid & Pa Kua Method", answer: "Lo Shu Grid And Pa Kua Method Helps Identify Strengths, Weaknesses, And Remedies To Improve Life Based On Ancient Numerology Techniques." },
            { question: "How Do I Get Date Of Birth Analysis", answer: "Select Date Of Birth Analysis Priced At ₹199, Add To Cart, Enter Your DOB, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Date Of Birth Analysis", answer: "Date Of Birth Analysis Provides Insights Into Personality, Life Path, Challenges, And Destiny Based On Your Birth Date." },
            { question: "How Do I Get Career Suggestions", answer: "Select Career Suggestions Service Priced At ₹499, Add To Cart, Provide Birth Details, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Are Career Suggestions", answer: "Astroshrae Provides Personalized Career Guidance Based On Your Numbers And Life Path To Maximize Success And Satisfaction." },
            { question: "How Do I Get Auspicious Pregnancy Dates", answer: "Select Auspicious Pregnancy Dates Service Priced At ₹499, Add To Cart, Provide Couple Details, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Are Auspicious Pregnancy Dates", answer: "Astroshrae Suggests Lucky Dates For Conception Or Childbirth To Ensure Health, Prosperity, And Positive Energy." },
            { question: "How Do I Get All Courses Without Name Correction", answer: "Select All Courses Without Name Correction Priced At ₹3499, Add To Cart, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Are All Courses Without Name Correction", answer: "A Complete Set Of Numerology Courses, Excluding Name Correction, To Help You Learn And Apply Numerology Effectively." },
            { question: "How Do I Get Zodiac Sign Report", answer: "Select Zodiac Sign Service Priced At ₹101, Add To Cart, Provide DOB, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Zodiac Sign Report", answer: "Zodiac Sign Report Provides Insights Into Your Sun Sign And Its Interactions With Numerology For Better Life Decisions." },
            { question: "How Do I Get Bracelet Guidance", answer: "Select Bracelet Guidance Service Priced At ₹399, Add To Cart, Provide Details, Complete Checkout, And Confirm On WhatsApp." },
            { question: "What Is Bracelet Guidance", answer: "Bracelet Guidance Suggests Personalized Lucky Bracelets Based On Numerology To Improve Success, Health, And Harmony." },
            { question: "Can Numerology Help Improve Relationships", answer: "Yes, Numerology Can Analyze Compatibility And Suggest Remedies To Enhance Relationships And Partnership Harmony." },
            { question: "Can Numerology Help In Career Growth", answer: "Yes, Numerology Can Guide Career Choices, Timing, And Opportunities Based On Life Path And Name Numbers." },
            { question: "Can Numerology Suggest Lucky Names", answer: "Yes, Numerology Can Recommend Names Aligned With Your Numbers To Bring Success, Luck, And Positive Energy." },
            { question: "Can Numerology Help In Choosing Lucky Vehicle Numbers", answer: "Yes, Numerology Can Analyze Your Vehicle Number And Suggest Changes Or Modifications To Bring Luck, Safety, And Success In Journeys." },
            { question: "Can Numerology Help In Choosing Phone Numbers", answer: "Yes, Numerology Can Suggest Mobile Numbers That Align With Your Life Path And Bring Positive Energy." },
            { question: "Can Numerology Help In Naming A Child", answer: "Yes, Astroshrae Can Suggest Baby Names Aligned With Numerology Principles To Ensure Success And Harmony In Life." },
            { question: "Can Numerology Help In Choosing A Business Name", answer: "Yes, Numerology Can Recommend Business Names That Bring Prosperity, Growth, And Positive Energy." },
            { question: "Can Numerology Help In Choosing Lucky Dates For Events", answer: "Yes, Numerology Can Suggest Auspicious Dates For Marriage, Travel, Business Launch, And Personal Milestones." },
            { question: "Does Astroshrae Provide Free Numerology Guidance", answer: "Astroshrae Offers Limited Free Insights But Full Personalized Reports And Services Are Paid." },
            { question: "Can Numerology Help Improve Personal Life", answer: "Yes, Numerology Can Provide Guidance And Remedies To Improve Relationships, Confidence, And Daily Decision Making." },
            { question: "Can Numerology Help In Financial Decisions", answer: "Yes, Numerology Can Suggest Favorable Numbers, Dates, And Remedies To Improve Financial Growth And Stability." },
            { question: "Can Numerology Predict Life Events", answer: "Numerology Provides Guidance On Likely Trends And Challenges Based On Numbers But Cannot Guarantee Exact Outcomes." },
            { question: "Can Astroshrae Help With Signature Analysis", answer: "Yes, Astroshrae Analyzes Signatures And Suggests Changes To Enhance Personal And Professional Success." },
            { question: "Can Numerology Suggest Remedies For Missing Numbers", answer: "Yes, Astroshrae Identifies Missing Numbers In Your Name Or Date Of Birth And Provides Remedies To Balance Energy." },
            { question: "Does Astroshrae Offer Numerology Courses", answer: "Yes, Astroshrae Provides Detailed Numerology Courses Including All Services Except Name Correction In Complete Packages." },
            { question: "How Do I Access Numerology Courses", answer: "You Can Purchase Courses Online, Complete Checkout, And Receive Access Instructions From Astroshrae On WhatsApp." },
            { question: "Can Numerology Help Improve Career Timing", answer: "Yes, Numerology Can Suggest Favorable Periods And Timing For Career Advancement And Business Decisions." },
            { question: "Can Numerology Help Improve Marriage Harmony", answer: "Yes, Astroshrae Provides Detailed Compatibility Analysis And Remedies To Enhance Relationship Harmony." },
            { question: "Can Numerology Guide In Choosing Lucky Colors", answer: "Yes, Numerology Can Suggest Colors That Align With Your Numbers To Promote Health, Wealth, And Positive Energy." },
            { question: "Can Numerology Guide In Choosing Lucky Gemstones", answer: "Yes, Astroshrae Can Recommend Gemstones Based On Your Numbers To Enhance Luck, Health, And Prosperity." },
            { question: "Can Numerology Suggest Lucky Signatures", answer: "Yes, Numerology Can Analyze Your Signature And Suggest Modifications For Personal And Professional Growth." },
            { question: "Does Astroshrae Provide Guidance On Auspicious Pregnancy Dates", answer: "Yes, Astroshrae Suggests Lucky Dates For Conception Or Childbirth To Ensure Health And Prosperity." },
            { question: "Can Numerology Help Students Choose Education Path", answer: "Yes, Numerology Can Analyze Life Path Numbers And Suggest Suitable Courses And Careers For Students." },
            { question: "Can Numerology Help With Stress Management", answer: "Yes, Numerology Can Suggest Remedies And Energy Balancing Techniques To Reduce Stress And Improve Mental Health." },
            { question: "Can Numerology Help In Spiritual Growth", answer: "Yes, Numerology Can Provide Guidance, Meditation Practices, And Energy Alignment To Support Spiritual Development." },
            { question: "Does Astroshrae Provide Career Suggestions", answer: "Yes, Astroshrae Offers Personalized Career Guidance Based On Your Numbers And Life Path For Better Success." },
            { question: "Can Numerology Help In Choosing Lucky House Numbers", answer: "Yes, Astroshrae Can Analyze House Numbers And Recommend Changes To Enhance Prosperity And Harmony." },
            { question: "Does Astroshrae Provide Lo Shu Grid Analysis", answer: "Yes, Astroshrae Provides Lo Shu Grid And Pa Kua Method Analysis To Identify Strengths, Weaknesses, And Remedies." },
            { question: "Can Numerology Guide Business Partnerships", answer: "Yes, Numerology Can Help Analyze Compatibility Between Business Partners For Successful Collaboration." },
            { question: "Can Numerology Help Improve Health", answer: "Yes, Numerology Can Suggest Remedies And Energy Practices To Support Physical And Mental Wellbeing." },
            { question: "Does Astroshrae Provide Trigram Therapy", answer: "Yes, Astroshrae Provides Trigram Therapy To Align Your Life With Natural Energy Patterns For Health, Wealth, And Harmony." },
            { question: "Can Numerology Suggest Remedies For Negative Energy", answer: "Yes, Astroshrae Can Recommend Colors, Numbers, Gemstones, And Spiritual Practices To Reduce Negative Energy." },
            { question: "Can Astroshrae Help With Financial Planning", answer: "Yes, Numerology Can Provide Guidance On Timing, Lucky Numbers, And Remedies To Support Financial Decisions." },
            { question: "Can Numerology Help Improve Daily Life Decisions", answer: "Yes, Numerology Can Guide You In Making Better Choices In Personal, Professional, And Social Life." },
            { question: "Does Astroshrae Provide Feng Shui Recommendations", answer: "Yes, Astroshrae Provides Feng Shui Remedies Based On Your Numbers To Promote Positive Energy At Home Or Office." },
            { question: "Can Numerology Help Choose Lucky Dates For Travel", answer: "Yes, Numerology Can Suggest Auspicious Travel Dates To Avoid Obstacles And Promote Safety And Success." },
            { question: "Can Numerology Help With Exam Preparation", answer: "Yes, Numerology Can Suggest Favorable Periods, Numbers, And Remedies To Improve Focus And Performance." },
            { question: "Can Numerology Help In Spiritual Growth", answer: "Yes, Numerology Can Provide Guidance, Meditation Practices, And Energy Alignment To Support Spiritual Development." }
        ];

        // --- NEW ROUTING LOGIC ---
        const navigateTo = (path) => {
            // Ensure path starts with a / for absolute paths from the root
            const absolutePath = path.startsWith('/') ? path : `/${path}`;
            history.pushState(null, null, absolutePath);
            router();
        };

        const router = async () => {
            const path = location.pathname;
            showPage(path);
        };
        
        window.addEventListener("popstate", router);

        document.addEventListener("DOMContentLoaded", () => {
            document.body.addEventListener("click", e => {
                // Check if the clicked element or its parent is an anchor tag
                const anchor = e.target.closest("a");
                if (anchor) {
                    const href = anchor.getAttribute('href');
                    // Check if it's an internal link and not a target="_blank"
                    if (href && href.startsWith('/') && anchor.target !== '_blank') {
                        e.preventDefault();
                        // Special handling for menu button to open modal (don't navigate to /menu page)
                        if (anchor.id === 'menu-btn') {
                            openModal("#menu-modal");
                        } else {
                            navigateTo(href);
                        }
                    } else if (href && href.startsWith(window.location.origin) && anchor.target !== '_blank') {
                        // Handle fully qualified internal URLs if they appear, e.g., https://astroshrae.rf.gd/cart
                        e.preventDefault();
                        navigateTo(href.replace(window.location.origin, ''));
                    }
                }
            });
        });
        // --- END NEW ROUTING LOGIC ---

        const showPage = (pathname) => {
            const pathSegments = pathname.split('/').filter(Boolean); 
            let pageId = pathSegments[0] || 'home'; // Default to 'home' if path is empty

            // Map custom paths to internal page IDs
            if (pathname === '/' || pathname === '/home') {
                pageId = 'home';
            } else if (pathname === '/login') {
                pageId = 'home'; // Login modal is shown, main content remains home
                openModal('#login-modal');
            } else if (pathname === '/register') {
                pageId = 'home'; // Register modal is shown, main content remains home
                openModal('#register-modal');
            } else if (pathname === '/checkout-details') {
                pageId = 'cart'; // Checkout modal is shown over cart
            } else if (pathname === '/payment-method-selection') {
                pageId = 'cart'; // Payment modal is shown over cart
            } else if (pathname === '/menu') {
                pageId = 'home'; // Menu modal is shown over home
            }


            const helpPopup = $("#help-popup");
            if (pageId === 'faqs') {
                helpPopup.classList.add('active');
            } else {
                helpPopup.classList.remove('active');
            }

            if (pageId === 'product' && pathSegments[1]) {
                const productMatch = products.find(p => sanitizeProductNameForUrl(p.name) === pathSegments[1]);
                if (productMatch) {
                    renderProductPreview(productMatch);
                } else {
                    navigateTo('/home'); // Fallback to home if product not found
                }
                return;
            }

            if ((pageId === "order" || pageId === "profile") && !currentUser) {
                toast("Please login to access this page.", "info");
                openModal("#login-modal");
                navigateTo("/home"); // Redirect to home, but show login modal
                return;
            }

            $$(".page").forEach(p=>p.classList.remove("active"));
            const targetPage = $(`#${pageId}`);
            if(targetPage) {
                targetPage.classList.add("active");
            } else {
                 $('#home').classList.add('active'); // Fallback to home for unknown pages
            }

            $$(".bottom-nav a").forEach(a => {
                const target = a.dataset.target;
                const normalizedPath = pageId === 'home' ? 'home' : pageId; // Treat '/' as 'home'
                if(target === normalizedPath) {
                     a.classList.add("active");
                } else {
                    a.classList.remove("active");
                }
            });
            
            if (pageId === 'cart') renderCart();
            if (pageId === 'profile') renderProfile();
            if (pageId === 'faqs') renderFAQs();
            if (pageId === 'reviews') renderReviews();
            if (pageId === 'order') onValue(ref(db, `orders/${currentUser.uid}`), renderOrders, { onlyOnce: false }); // Re-attach listener if navigating
            
            // Handle modals directly if path maps to a modal state
            if (pathname === '/login') {
                openModal('#login-modal');
            } else if (pathname === '/register') {
                openModal('#register-modal');
            } else if (pathname === '/checkout-details') {
                openModal('#checkout-modal');
            } else if (pathname === '/payment-method-selection') {
                openModal('#payment-method-modal');
            } else if (pathname === '/menu') {
                openModal('#menu-modal');
            }


            if (pageId === 'feedback') {
                const nameGroup = $('#unregistered-name-group');
                const nameInput = $('#unregistered-user-name');
                if (currentUser) {
                    nameGroup.style.display = 'none';
                } else {
                    nameGroup.style.display = 'block';
                    nameInput.value = localStorage.getItem('guest_submitted_name') || "";
                }
                if (!currentFeedbackIdForEdit) {
                    resetFeedbackForm();
                    $("#feedback-form-title").textContent = "ASTROSHRAE FEEDBACK";
                    $("#feedback-submit-btn").textContent = "Submit";
                }
            }

            if (!['success', 'failure', 'pay-later-confirm-page'].includes(pageId)) {
                resetOrderState();
            }
        };

        const renderFAQs = () => {
            const faqsListDiv = $("#faqs-list");
            faqsListDiv.innerHTML = "";
            faqsData.forEach((faq) => {
                const faqItem = document.createElement("div");
                faqItem.className = "faq-item";
                faqItem.innerHTML = `
                    <div class="faq-question">
                        <span>${faq.question}</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>${faq.answer}</p>
                    </div>
                `;
                faqsListDiv.appendChild(faqItem);
                faqItem.querySelector(".faq-question").onclick = () => {
                    faqItem.classList.toggle("active");
                    const answer = faqItem.querySelector(".faq-answer");
                    if (faqItem.classList.contains("active")) {
                        answer.style.maxHeight = answer.scrollHeight + "px";
                    } else {
                        answer.style.maxHeight = "0";
                    }
                };
            });
        };

        const setupFeedbackForm = () => {
            const form = $("#feedback-form");
            $$(".feedback-options").forEach(optionsGroup => {
                const type = optionsGroup.dataset.type;
                optionsGroup.querySelectorAll('label.feedback-option').forEach(label => {
                    const input = label.querySelector('input[type="checkbox"], input[type="radio"]');
                    const otherInput = label.querySelector('input[type="text"]');
                    if (otherInput) {
                        otherInput.style.display = 'none';
                        input.addEventListener('change', () => {
                            if (input.checked && input.value === input.dataset.originalValue) {
                                otherInput.style.display = 'inline-block';
                            } else {
                                otherInput.style.display = 'none';
                                otherInput.value = '';
                                input.value = input.dataset.originalValue;
                            }
                        });
                        otherInput.addEventListener('input', () => {
                            if (input.checked && input.dataset.originalValue === 'Other') {
                                input.value = `Other: ${otherInput.value.trim()}`;
                            }
                        });
                    }
                    input.addEventListener('change', () => {
                        if (type === 'radio') {
                            optionsGroup.querySelectorAll('label.feedback-option').forEach(otherLabel => {
                                otherLabel.classList.remove('selected');
                                const otherOtherInput = otherLabel.querySelector('input[type="text"]');
                                const otherInputRadio = otherLabel.querySelector('input[type="radio"]');
                                if (otherOtherInput) {
                                    otherOtherInput.style.display = 'none';
                                    otherOtherInput.value = '';
                                }
                                if(otherInputRadio && otherInputRadio.dataset.originalValue) {
                                    otherInputRadio.value = otherInputRadio.dataset.originalValue;
                                }
                            });
                        }
                        label.classList.toggle('selected', input.checked);
                        if(input.checked && input.dataset.originalValue === 'Other' && otherInput) {
                            otherInput.focus();
                        }
                    });
                     if (input.value === 'Other' || input.dataset.originalValue === 'Other') {
                        input.dataset.originalValue = 'Other';
                    } else if (!input.dataset.originalValue) {
                        input.dataset.originalValue = input.value;
                    }
                });
            });
            $$(".star-rating").forEach(ratingContainer => {
                const hiddenInput = $(`#${ratingContainer.dataset.question}_input`);
                const stars = ratingContainer.querySelectorAll('i');
                const updateStars = (currentRating) => {
                    stars.forEach(star => {
                        if (parseInt(star.dataset.value) <= currentRating) {
                            star.classList.remove('far');
                            star.classList.add('fas', 'active');
                        } else {
                            star.classList.remove('fas', 'active');
                            star.classList.add('far');
                        }
                    });
                    hiddenInput.value = currentRating;
                    ratingContainer.dataset.rating = currentRating;
                };
                stars.forEach(star => {
                    star.onclick = () => {
                        updateStars(parseInt(star.dataset.value));
                    };
                    star.onmouseover = () => {
                        const hoverValue = parseInt(star.dataset.value);
                        stars.forEach(s => {
                            if (parseInt(s.dataset.value) <= hoverValue) {
                                s.classList.remove('far');
                                s.classList.add('fas', 'active');
                            } else {
                                s.classList.remove('fas', 'active');
                                s.classList.add('far');
                            }
                        });
                    };
                    star.onmouseout = () => {
                        updateStars(parseInt(ratingContainer.dataset.rating));
                    };
                });
                updateStars(0);
            });
            form.onsubmit = async e => {
                e.preventDefault();
                showLoading(currentFeedbackIdForEdit ? "Updating feedback..." : "Submitting feedback...");
                let finalUserName;
                let finalUserId;
                if (currentUser) {
                    finalUserName = userProfile.name || currentUser.email;
                    finalUserId = currentUser.uid;
                } else {
                    finalUserName = $("#unregistered-user-name").value.trim();
                    finalUserId = "guest_" + Date.now(); 
                    if (!finalUserName) {
                         hideLoading();
                         toast("Please enter your name to submit feedback.", "danger");
                         return;
                    }
                }
                const feedbackData = {
                    userId: finalUserId,
                    userName: finalUserName,
                    timestamp: Date.now(),
                    helpfulCount: 0 // Initialize helpful count
                };
                const q1Services = [];
                form.querySelectorAll('input[name="q1_services"]:checked').forEach(input => {
                    if (input.value.startsWith('Other:')) {
                        q1Services.push(input.value);
                    } else if (input.dataset.originalValue === 'Other') {
                        const otherInput = input.closest('label').querySelector('input[name="q1_services_other"]');
                        if (otherInput && otherInput.value.trim()) q1Services.push(`Other: ${otherInput.value.trim()}`);
                        else q1Services.push('Other (not specified)');
                    } else {
                        q1Services.push(input.value);
                    }
                });
                feedbackData.q1_services = q1Services;
                feedbackData.q2_feeling = $("#q2_feeling").value.trim();
                ['q3_onTime', 'q4_polite', 'q5_useful', 'q6_pricing', 'q11_updates'].forEach(qName => {
                    const selectedRadio = form.querySelector(`input[name="${qName}"]:checked`);
                    if (selectedRadio) {
                         if (selectedRadio.value.startsWith('Other:')) {
                            feedbackData[qName] = selectedRadio.value;
                        } else if (selectedRadio.dataset.originalValue === 'Other') {
                            const otherInput = selectedRadio.closest('label').querySelector(`input[name="${qName}_other"]`);
                            feedbackData[qName] = otherInput && otherInput.value.trim() ? `Other: ${otherInput.value.trim()}` : 'Other (not specified)';
                        } else {
                            feedbackData[qName] = selectedRadio.value;
                        }
                    }
                });
                feedbackData.q7_recommend = parseInt($("#q7_recommend_input").value) || 0;
                feedbackData.q10_overallRating = parseInt($("#q10_overallRating_input").value) || 0;
                const q8HeardAboutUs = [];
                form.querySelectorAll('input[name="q8_heardAboutUs"]:checked').forEach(input => {
                    if (input.value.startsWith('Other:')) {
                        q8HeardAboutUs.push(input.value);
                    } else if (input.dataset.originalValue === 'Other') {
                        const otherInput = input.closest('label').querySelector('input[name="q8_heardAboutUs_other"]');
                        if (otherInput && otherInput.value.trim()) q8HeardAboutUs.push(`Other: ${otherInput.value.trim()}`);
                        else q8HeardAboutUs.push('Other (not specified)');
                    } else {
                        q8HeardAboutUs.push(input.value);
                    }
                });
                feedbackData.q8_heardAboutUs = q8HeardAboutUs;
                feedbackData.q9_improve = $("#q9_improve").value.trim();
                if (!feedbackData.q2_feeling || feedbackData.q7_recommend === 0 || feedbackData.q10_overallRating === 0) {
                    hideLoading();
                    toast("Please fill in all required fields (feedback text and ratings).", "danger");
                    return;
                }
                try {
                    if (currentFeedbackIdForEdit) {
                        if (feedbackData.userId.startsWith("guest_")) delete feedbackData.userId; 
                        await update(ref(db, `feedback/${currentFeedbackIdForEdit}`), feedbackData);
                        toast("Feedback updated successfully! Thank you.", "success");
                    } else {
                        const newRef = await push(ref(db, "feedback"), feedbackData);
                        toast("Feedback submitted successfully! Thank you.", "success");
                        if (!currentUser) {
                             localStorage.setItem('guest_submitted_name', finalUserName);
                        }
                    }
                    form.reset();
                    resetFeedbackForm();
                    currentFeedbackIdForEdit = null;
                    navigateTo("/reviews");
                } catch (error) {
                    console.error("Error submitting feedback:", error);
                    toast("Failed to submit feedback. Please try again.", "danger");
                } finally {
                    hideLoading();
                }
            };
        };

        const resetFeedbackForm = () => {
            const form = $("#feedback-form");
            form.reset();
            $("#feedback-id-input").value = "";
            $$(".feedback-options").forEach(optionsGroup => {
                optionsGroup.querySelectorAll('label.feedback-option').forEach(label => {
                    label.classList.remove('selected');
                    const input = label.querySelector('input[type="checkbox"], input[type="radio"]');
                    if (input) {
                        input.checked = false;
                        if (input.dataset.originalValue) input.value = input.dataset.originalValue;
                    }
                    const otherInput = label.querySelector('input[type="text"]');
                    if (otherInput) {
                        otherInput.style.display = 'none';
                        otherInput.value = '';
                    }
                });
            });
            $$(".star-rating").forEach(ratingContainer => {
                const hiddenInput = $(`#${ratingContainer.dataset.question}_input`);
                const stars = ratingContainer.querySelectorAll('i');
                stars.forEach(star => {
                    star.classList.remove('fas', 'active');
                    star.classList.add('far');
                });
                if (hiddenInput) hiddenInput.value = 0;
                ratingContainer.dataset.rating = 0;
            });
            currentFeedbackIdForEdit = null;
            $("#feedback-form-title").textContent = "ASTROSHRAE FEEDBACK";
            $("#feedback-submit-btn").textContent = "Submit";
        };

        const loadFeedbackForEdit = async (feedbackId) => {
            if (!currentUser) {
                toast("Only logged-in users can edit reviews.", "danger");
                return;
            }
            showLoading("Loading feedback for edit...");
            try {
                const snapshot = await get(ref(db, `feedback/${feedbackId}`));
                if (snapshot.exists()) {
                    const fb = snapshot.val();
                    currentFeedbackIdForEdit = feedbackId;
                    $("#feedback-id-input").value = feedbackId;
                    $("#feedback-form-title").textContent = "EDIT YOUR FEEDBACK";
                    $("#feedback-submit-btn").textContent = "Update Feedback";
                    navigateTo("/feedback"); 
                    fb.q1_services.forEach(service => {
                        let input = $(`input[name="q1_services"][value="${service}"]`);
                        if (input) {
                            input.checked = true;
                            input.closest('label').classList.add('selected');
                        } else if (service.startsWith('Other:')) {
                            const otherText = service.substring(6).trim();
                            const otherInput = $(`input[name="q1_services"][data-original-value="Other"]`);
                            if (otherInput) {
                                otherInput.checked = true;
                                otherInput.closest('label').classList.add('selected');
                                const otherTextInput = otherInput.closest('label').querySelector('input[name="q1_services_other"]');
                                if (otherTextInput) {
                                    otherTextInput.value = otherText;
                                    otherTextInput.style.display = 'inline-block';
                                    otherInput.value = service;
                                }
                            }
                        }
                    });
                    $("#q2_feeling").value = fb.q2_feeling;
                    ['q3_onTime', 'q4_polite', 'q5_useful', 'q6_pricing', 'q11_updates'].forEach(qName => {
                        const value = fb[qName];
                        let input = $(`input[name="${qName}"][value="${value}"]`);
                        if (input) {
                            input.checked = true;
                            input.closest('label').classList.add('selected');
                        } else if (value && value.startsWith('Other:')) {
                            const otherText = value.substring(6).trim();
                            const otherInput = $(`input[name="${qName}"][data-original-value="Other"]`);
                            if (otherInput) {
                                otherInput.checked = true;
                                otherInput.closest('label').classList.add('selected');
                                const otherTextInput = otherInput.closest('label').querySelector(`input[name="${qName}_other"]`);
                                if (otherTextInput) {
                                    otherTextInput.value = otherText;
                                    otherTextInput.style.display = 'inline-block';
                                    otherInput.value = value;
                                }
                            }
                        }
                    });
                    $$(".star-rating").forEach(ratingContainer => {
                        const question = ratingContainer.dataset.question;
                        const ratingValue = fb[question];
                        const hiddenInput = $(`#${question}_input`);
                        const stars = ratingContainer.querySelectorAll('i');
                        stars.forEach(star => {
                            if (parseInt(star.dataset.value) <= ratingValue) {
                                star.classList.remove('far');
                                star.classList.add('fas', 'active');
                            } else {
                                star.classList.remove('fas', 'active');
                                star.classList.add('far');
                            }
                        });
                        if (hiddenInput) hiddenInput.value = ratingValue;
                        ratingContainer.dataset.rating = ratingValue;
                    });
                    fb.q8_heardAboutUs.forEach(source => {
                        let input = $(`input[name="q8_heardAboutUs"][value="${source}"]`);
                        if (input) {
                            input.checked = true;
                            input.closest('label').classList.add('selected');
                        } else if (source.startsWith('Other:')) {
                            const otherText = source.substring(6).trim();
                            const otherInput = $(`input[name="q8_heardAboutUs"][data-original-value="Other"]`);
                            if (otherInput) {
                                otherInput.checked = true;
                                otherInput.closest('label').classList.add('selected');
                                const otherTextInput = otherInput.closest('label').querySelector('input[name="q8_heardAboutUs_other"]');
                                if (otherTextInput) {
                                    otherTextInput.value = otherText;
                                    otherTextInput.style.display = 'inline-block';
                                    otherInput.value = source;
                                }
                            }
                        }
                    });
                    $("#q9_improve").value = fb.q9_improve;
                } else {
                    toast("Feedback entry not found.", "danger");
                    resetFeedbackForm();
                }
            } catch (error) {
                console.error("Error loading feedback for edit:", error);
                toast("Failed to load feedback for editing.", "danger");
                resetFeedbackForm();
            } finally {
                hideLoading();
            }
        };

        const deleteFeedback = async (feedbackId) => {
            if (!currentUser) {
                toast("Please log in to delete your feedback.", "danger");
                return;
            }
            if (!confirm("Are you sure you want to delete this feedback? This action cannot be undone.")) {
                return;
            }

            showLoading("Deleting feedback...");
            try {
                // Ensure only the owner can delete, though this should ideally be server-side
                const snapshot = await get(ref(db, `feedback/${feedbackId}`));
                const feedback = snapshot.val();
                if (feedback && feedback.userId === currentUser.uid) {
                    await remove(ref(db, `feedback/${feedbackId}`));
                    toast("Feedback deleted successfully!", "success");
                } else {
                    toast("You do not have permission to delete this feedback.", "danger");
                }
            } catch (error) {
                console.error("Error deleting feedback:", error);
                toast("Failed to delete feedback. Please try again.", "danger");
            } finally {
                hideLoading();
            }
        };

        const handleHelpfulClick = async (feedbackId, buttonType) => {
            // Prevent multiple clicks from the same session for this review
            if (sessionStorage.getItem(`helpful_review_${feedbackId}`)) {
                toast("You've already voted on this review!", "info");
                return;
            }

            const feedbackRef = ref(db, `feedback/${feedbackId}`);
            try {
                await runTransaction(feedbackRef, (currentFeedback) => {
                    if (currentFeedback) {
                        currentFeedback.helpfulCount = (currentFeedback.helpfulCount || 0) + (buttonType === 'yes' ? 1 : 0);
                    }
                    return currentFeedback;
                });
                sessionStorage.setItem(`helpful_review_${feedbackId}`, 'true'); // Mark as voted in session
                toast("Your vote has been recorded!", "success");
            } catch (error) {
                console.error("Error updating helpful count:", error);
                toast("Failed to record your vote. Please try again.", "danger");
            }
        };

        const renderReviews = () => {
            const reviewsListDiv = $("#reviews-list");
            reviewsListDiv.innerHTML = "<p>Loading reviews...</p>"; // Initial loading state
            onValue(ref(db, "feedback"), (snapshot) => {
                reviewsListDiv.innerHTML = ""; // Clear loading message
                if (snapshot.exists()) {
                    const feedbackEntries = snapshot.val();
                    const reviews = Object.entries(feedbackEntries).map(([id, data]) => ({ id, ...data })).reverse();
                    if (reviews.length === 0) {
                        reviewsListDiv.innerHTML = "<p>No reviews yet. Be the first to leave feedback!</p>";
                        return;
                    }
                    reviews.forEach(fb => {
                        if (fb.q2_feeling && fb.userName) {
                            const reviewBox = document.createElement("div");
                            reviewBox.className = "review-box";
                            const starsHtml = Array(5).fill().map((_, i) => 
                                `<i class="${i < fb.q10_overallRating ? 'fas' : 'far'} fa-star"></i>`
                            ).join('');
                            const isCurrentUserReview = currentUser && fb.userId === currentUser.uid;
                            
                            const helpfulCount = fb.helpfulCount || 0;
                            const hasVoted = sessionStorage.getItem(`helpful_review_${fb.id}`);

                            reviewBox.innerHTML = `
                                <div class="reviewer-name">
                                    <span>${fb.userName}</span>
                                    <span>${new Date(fb.timestamp).toLocaleDateString()}</span>
                                </div>
                                <div class="review-stars">${starsHtml}</div>
                                <div class="review-text">${fb.q2_feeling}</div>
                                <div class="review-actions">
                                    <div class="helpful-buttons">
                                        <span>Was this review helpful?</span>
                                        <button class="helpful-yes-btn" data-feedback-id="${fb.id}" ${hasVoted ? 'disabled' : ''}>Yes</button>
                                        <button class="helpful-no-btn" data-feedback-id="${fb.id}" ${hasVoted ? 'disabled' : ''}>No</button>
                                        <span class="helpful-count-text">${helpfulCount} people found this helpful</span>
                                    </div>
                                    <div class="user-review-actions">
                                        ${isCurrentUserReview ? `<button class="edit-review-btn" data-feedback-id="${fb.id}">Edit</button>` : ''}
                                        ${isCurrentUserReview ? `<button class="delete-review-btn" data-feedback-id="${fb.id}">Delete</button>` : ''}
                                    </div>
                                </div>
                            `;

                            // NEW: Check for and render the admin reply
                            if (fb.reply) {
                                const replyText = typeof fb.reply === 'string' ? fb.reply : (fb.reply.text || '');
                                const adminName = (typeof fb.reply === 'object' && fb.reply.adminName) ? fb.reply.adminName : "Astroshrae Support";
                                const replyTimestamp = (typeof fb.reply === 'object' && fb.reply.timestamp) ? new Date(fb.reply.timestamp).toLocaleDateString() : '';

                                if (replyText) {
                                    const replyBox = document.createElement('div');
                                    replyBox.className = 'admin-reply';
                                    replyBox.innerHTML = `
                                        <strong class="admin-reply-header">
                                            <i class="fas fa-star"></i> Reply from ${adminName}
                                            ${replyTimestamp ? `<span class="admin-reply-date">${replyTimestamp}</span>` : ''}
                                        </strong>
                                        <p class="admin-reply-text">${replyText}</p>
                                    `;
                                    reviewBox.appendChild(replyBox);
                                }
                            }
                            
                            reviewsListDiv.appendChild(reviewBox);

                            // Attach event listeners for helpfulness
                            const yesButton = reviewBox.querySelector(".helpful-yes-btn");
                            const noButton = reviewBox.querySelector(".helpful-no-btn");
                            if (yesButton) {
                                yesButton.onclick = () => handleHelpfulClick(fb.id, 'yes');
                            }
                            if (noButton) {
                                noButton.onclick = () => handleHelpfulClick(fb.id, 'no'); // 'No' doesn't increment visible count for now
                            }

                            // Attach event listeners for edit/delete
                            if (isCurrentUserReview) {
                                reviewBox.querySelector(".edit-review-btn").onclick = () => {
                                    loadFeedbackForEdit(fb.id);
                                };
                                reviewBox.querySelector(".delete-review-btn").onclick = () => {
                                    deleteFeedback(fb.id);
                                };
                            }
                        }
                    });
                } else {
                    reviewsListDiv.innerHTML = "<p>No reviews yet. Be the first to leave feedback!</p>";
                }
            }, (error) => {
                console.error("Error fetching reviews:", error);
                reviewsListDiv.innerHTML = "<p>Failed to load reviews. Please try again later.</p>";
                toast("Failed to load reviews.", "danger");
            });
        };
        
        // UI Event Listeners and App Initialization
        document.addEventListener("DOMContentLoaded", () => {
            $("#search-icon").onclick = ()=>navigateTo("/search");
            $("#profile-icon").onclick = ()=>navigateTo("/profile");

            $("#login-form").onsubmit = e=>{
                e.preventDefault();
                login($("#login-email").value,$("#login-password").value);
            };
            $("#login-close").onclick = ()=>{
                closeModal("#login-modal");
                navigateTo(location.pathname === '/login' ? '/home' : location.pathname);
            };
            $("#switch-to-register").onclick = e=>{
                e.preventDefault();
                closeModal("#login-modal");
                openModal("#register-modal");
                navigateTo("/register");
            };

            $("#register-form").onsubmit = e=>{
                e.preventDefault();
                register(
                    $("#register-name").value,
                    $("#register-dob").value,
                    $("#register-pob").value,
                    $("#register-tob").value,
                    $("#register-email").value,
                    $("#register-phone").value,
                    $("#register-password").value
                );
            };
            $("#register-close").onclick = ()=>{
                closeModal("#register-modal");
                navigateTo(location.pathname === '/register' ? '/home' : location.pathname);
            };
            $("#switch-to-login").onclick = e=>{
                e.preventDefault();
                closeModal("#register-modal");
                openModal("#login-modal");
                navigateTo("/login");
            };

            $("#checkout-btn").onclick = checkout;
            $("#checkout-close").onclick = ()=>{
                closeModal("#checkout-modal");
                navigateTo(location.pathname === '/checkout-details' ? '/cart' : location.pathname);
            };
            $("#checkout-form").onsubmit = e=>{
                e.preventDefault();
                if (validateShippingDetails()) {
                    openModal("#payment-method-modal");
                    navigateTo("/payment-method-selection");
                }
            };

            $("#payment-method-close").onclick = ()=>{
                closeModal("#payment-method-modal");
                navigateTo(location.pathname === '/payment-method-selection' ? '/cart' : location.pathname);
            };
            $("#pay-now-btn").onclick = startRazorpay;
            $("#pay-later-modal-btn").onclick = () => initiatePayLater();

            $("#failure-pay-now-btn").onclick = () => {
                if (pendingOrderId && pendingOrderData) {
                    startRazorpay();
                } else {
                    toast("No previous order details found to retry. Please go to cart and checkout again.", "info");
                    navigateTo("/cart");
                }
            };
            $("#failure-pay-later-btn").onclick = () => {
                if (pendingOrderId && pendingOrderData) {
                    initiatePayLater(pendingOrderData);
                } else {
                    toast("No previous order details found. Please go to cart and checkout again.", "info");
                    navigateTo("/cart");
                }
            };
            $("#failure-cancel-order-btn").onclick = cancelPendingOrder;

            $("#success-view-order-btn").onclick = ()=>navigateTo("/order");

            $("#order-edit-close").onclick = ()=>closeModal("#order-edit-modal");
            $("#order-edit-form").onsubmit = saveEditedOrder;

            $("#order-details-close").onclick = ()=>closeModal("#order-details-modal");

            $("#edit-profile-btn").onclick = openProfileEdit;
            $("#profile-edit-close").onclick = ()=>closeModal("#profile-edit-modal");
            $("#profile-edit-form").onsubmit = saveProfileEdit;

            $("#logout-btn").onclick = logout;

            $("#menu-btn").onclick = (e) => { e.preventDefault(); openModal("#menu-modal"); navigateTo("/menu");};
            $("#menu-close").onclick = ()=>{
                closeModal("#menu-modal");
                navigateTo(location.pathname === '/menu' ? '/home' : location.pathname);
            };
            // Modified menu links to use navigateTo
            $$(".menu-link").forEach(l=>{
                l.onclick = (e)=>{
                    e.preventDefault();
                    closeModal("#menu-modal");
                    navigateTo(l.getAttribute('href'));
                }
            });

            $("#share-modal").querySelector(".share-modal-close").onclick = ()=>closeModal("#share-modal");

            $("#contact-form").onsubmit = async e=>{
                e.preventDefault();
                const msg = {
                    name: $("#contact-name").value,
                    phone: $("#contact-phone").value,
                    email: $("#contact-email").value,
                    message: $("#contact-message").value,
                    date: Date.now()
                };
                showLoading("Sending message...");
                try {
                    await push(ref(db, "messages"), msg);
                    toast("Message sent successfully!");
                    $("#contact-form").reset();
                }
                catch (e) {
                    console.error("Error sending message:", e);
                    toast("Failed to send message.", "danger");
                } finally {
                    hideLoading();
                }
            };

            $("#apply-coupon").onclick = applyCoupon;

            $("#search-input").oninput = e=>{
                const term = e.target.value.toLowerCase();
                const results = products.filter(p=>p.name.toLowerCase().includes(term));
                const grid = $("#search-results");
                grid.innerHTML = "";
                results.forEach(p=>{
                    const card = document.createElement("div");
                    card.className = "product-card";
                    const heart = wishlist[p.id] ? "❤️" : "🖤";
                    const productUrlPath = `/product/${sanitizeProductNameForUrl(p.name)}`;
                    card.innerHTML = `
                        <a href="${productUrlPath}" style="text-decoration:none; color:inherit;">
                            <div class="product-image-container">
                                <img src="${p.imageUrl}" alt="${p.name}" loading="lazy">
                                <div class="share-icon" data-id="${p.id}"><i class="fas fa-share-alt"></i></div>
                            </div>
                            <h4>${p.name}</h4>
                        </a>
                        <p class="price">${fmt(p.price)}</p>
                        <div class="actions">
                            <button class="add-cart" data-id="${p.id}">Add to Cart</button>
                            <span class="wishlist" data-id="${p.id}">${heart}</span>
                        </div>
                        <a href="${productUrlPath}" class="view-details-btn" data-id="${p.id}">View Details</a>
                    `;
                    card.querySelector(".add-cart").onclick = ev=>{ ev.stopPropagation(); addToCart(p); };
                    const wIcon = card.querySelector(".wishlist");
                    wIcon.onclick = ev=>{ ev.stopPropagation(); toggleWishlist(p); wIcon.textContent = wishlist[p.id] ? "❤️" : "🖤"; };
                    const shareIcon = card.querySelector(".share-icon");
                    shareIcon.onclick = (ev)=>{ ev.stopPropagation(); ev.preventDefault(); openShareModal(p); };
                    grid.appendChild(card);
                });
            };

            setupFeedbackForm();

            // Initialize App
            renderSkeletonProducts(); // Show placeholders first for better perceived performance
            authListener();
            loadProducts().then(() => {
                router(); // Route only after products are loaded to handle direct product links
            });
            loadSlider();
        });

    </script>
</body>
</html>
